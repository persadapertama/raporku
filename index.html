<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aplikasi Sekolah Terpadu</title>
<!-- SheetJS for reading/writing Excel in browser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        background-color: #f4f4f4;
    }

    /* Sidebar */
    #sidebar {
        width: 250px;
        background-color: #0b3d0b; /* hijau tua */
        color: white;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        transform: translateX(0);
        transition: 0.3s;
        padding-top: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        overflow-y: auto;
    }

    #sidebar.hidden {
        transform: translateX(-260px);
    }

    #sidebar h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    #sidebar a {
        display: block;
        padding: 12px 20px;
        color: white;
        text-decoration: none;
        cursor: pointer;
    }

    #sidebar a:hover {
        background-color: #145214;
    }

    /* Dropdown Menu */
    .dropdown {
        position: relative;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #145214;
        min-width: 100%;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        left: 0;
    }

    .dropdown-content a {
        padding: 12px 20px;
        text-decoration: none;
        display: block;
        color: white;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    /* Tombol toggle */
    #toggleBtn {
        position: fixed;
        left: 260px;
        top: 15px;
        background-color: #0b3d0b;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        transition: 0.3s;
        z-index: 1000;
    }

    #toggleBtn.closed {
        left: 10px;
    }

    /* Konten kanan */
    #content {
        margin-left: 260px;
        padding: 20px;
        width: calc(100% - 260px);
        transition: 0.3s;
        background-color: #fff;
        min-height: 100vh;
        box-sizing: border-box;
    }

    #content.full {
        margin-left: 0;
        width: 100%;
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input[type="text"], input[type="file"], input[type="number"], input[type="search"], select, textarea {
        width: 100%;
        max-width: 400px;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
    }
    
    textarea {
        min-height: 100px;
        resize: vertical;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-family: Arial, sans-serif;
        font-size: 14px;
    }
    table, th, td {
        border: 1px solid #000;
    }
    th {
        background: #f0f0f0;
        padding: 8px;
        text-align: center;
        font-weight: bold;
    }
    td {
        padding: 6px;
        text-align: center;
    }

    .btn { 
        padding:10px 15px; 
        background:#0b3d0b; 
        color:#fff; 
        border:none; 
        cursor:pointer; 
        margin-right:8px;
        margin-top: 10px;
        border-radius: 4px;
    }
    .btn:hover {
        background-color: #145214;
    }
    .btn-delete {
        background-color: #d9534f;
    }
    .btn-delete:hover {
        background-color: #c9302c;
    }

    #tabelSiswa, #tabelNilai, #tabelNilaiP5, #tabelAbsen, #tabelEkstra { 
        max-height: 400px; 
        overflow-y: auto; 
        border:1px solid #ccc; 
        padding:8px;
        margin-top: 20px;
    }
    #tabelSiswa table, #tabelNilai table, #tabelNilaiP5 table, #tabelAbsen table, #tabelEkstra table { width:100%; border-collapse: collapse; }
    
    /* Gaya untuk daftar */
    #mapelList, #jurusanList, #ekstraList { 
        margin-top:12px; 
        list-style-type: none; 
        padding: 0;
    }
    #mapelList li, #jurusanList li, #ekstraList li { 
        margin-bottom:8px; 
        padding: 8px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Gaya Khusus untuk Tabel Nilai dengan Lebar Kolom Disesuaikan */
    #tabelNilai .nilai-table, #tabelNilaiP5 .nilai-table {
        table-layout: fixed;
        width: 100%;
    }
    #tabelNilai .nilai-table th, #tabelNilai .nilai-table td,
    #tabelNilaiP5 .nilai-table th, #tabelNilaiP5 .nilai-table td {
        border: 1px solid #000;
        padding: 8px 4px;
        word-wrap: break-word;
    }
    #tabelNilai .nilai-table th, #tabelNilaiP5 .nilai-table th {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        height: 120px;
        text-align: center;
        vertical-align: bottom;
    }
    /* Kolom No */
    #tabelNilai .nilai-table th:nth-child(1), #tabelNilai .nilai-table td:nth-child(1),
    #tabelNilaiP5 .nilai-table th:nth-child(1), #tabelNilaiP5 .nilai-table td:nth-child(1) {
        width: 40px;
        text-align: center;
    }
    /* Kolom Nama */
    #tabelNilai .nilai-table th:nth-child(2), #tabelNilai .nilai-table td:nth-child(2),
    #tabelNilaiP5 .nilai-table th:nth-child(2), #tabelNilaiP5 .nilai-table td:nth-child(2) {
        width: 200px;
        text-align: left;
        writing-mode: horizontal-tb;
        vertical-align: middle;
        height: auto;
    }
    /* Kolom Mata Pelajaran dan Nilai (dimulai dari kolom ke-3) */
    #tabelNilai .nilai-table th:nth-child(n+3), #tabelNilai .nilai-table td:nth-child(n+3),
    #tabelNilaiP5 .nilai-table th:nth-child(n+3), #tabelNilaiP5 .nilai-table td:nth-child(n+3) {
        width: 60px;
        text-align: center;
    }
    
    /* Tambahan untuk semester selector */
    .semester-container {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .semester-container > div {
        flex: 1;
        min-width: 200px;
    }

    /* Gaya untuk form Penilaian Wali Kelas */
    .wali-kelas-container {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
    }
    .wali-kelas-container h3 {
        margin-top: 0;
    }

    /* --- AWAL PERUBAHAN: CSS untuk form input sejajar --- */
    .input-master-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap; /* Agar responsif di layar kecil */
    }
    .input-group {
        flex: 1;
        min-width: 250px; /* Minimal lebar agar tidak terlalu sempit */
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .input-group label {
        margin-top: 0; /* Reset margin-top karena sudah ada padding */
    }
    .input-group input {
        max-width: 100%; /* Input mengikuti lebar container */
    }
    /* --- AKHIR PERUBAHAN --- */

    /* ======================= CSS UNTUK RAPOR ======================= */
    #raporContainer, #raporP5Container, #buktiAmbilRaporContainer {
        background-color: white;
        padding: 40px;
        font-family: 'Times New Roman', Times, serif;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        width: 210mm;
        min-height: 297mm;
        margin: 20px auto;
        box-sizing: border-box;
    }
    /* Header class tidak lagi digunakan, tapi dibiarkan agar tidak error */
    #raporContainer .header, #raporP5Container .header { text-align: center; margin-bottom: 20px; }
    #raporContainer .header img, #raporP5Container .header img { max-width: 80px; vertical-align: middle; }
    #raporContainer .header div, #raporP5Container .header div { display: inline-block; vertical-align: middle; margin-left: 15px; }
    #raporContainer .header h3, #raporP5Container .header h3 { margin: 5px 0; font-size: 16px; }
    #raporContainer .header h4, #raporP5Container .header h4 { margin: 5px 0; font-size: 12px; }
    #raporContainer h2, #raporP5Container h2 { text-align: center; margin: 30px 0 20px 0; font-size: 18px; text-decoration: underline; }
    #raporContainer .identity-table, #raporP5Container .identity-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 20px; }
    #raporContainer .identity-table td, #raporP5Container .identity-table td { border: none; padding:4px; }
    #raporContainer .identity-table td:first-child, #raporP5Container .identity-table td:first-child { width: 150px; font-weight: bold; }
    #raporContainer table, #raporP5Container table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 11px; }
    #raporContainer table, #raporContainer th, #raporContainer td, #raporP5Container table, #raporP5Container th, #raporP5Container td { border: 1px solid black; }
    #raporContainer th, #raporContainer td, #raporP5Container th, #raporP5Container td { padding: 6px; vertical-align: top; text-align: left; }
    #raporContainer th, #raporP5Container th { text-align: center; background-color: #f2f2f2; }
    #raporContainer .signatures, #raporP5Container .signatures { display: flex; justify-content: space-between; margin-top: 50px; font-size: 12px; }
    #raporContainer .signature-box, #raporP5Container .signature-box { text-align: center; width: 30%; }
    /* Placeholder untuk garis tangan dihapus */
    @media print {
        body * { visibility: hidden; }
        #raporContainer, #raporContainer *, #raporP5Container, #raporP5Container *, #buktiAmbilRaporContainer, #buktiAmbilRaporContainer * { visibility: visible; }
        #raporContainer, #raporP5Container, #buktiAmbilRaporContainer { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; padding: 20px; }
        .no-print { display: none !important; }
    }
    
    /* CSS untuk tabel KD */
    #kdTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    #kdTable th, #kdTable td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    #kdTable th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    #kdTable input {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
    }

/* ==== MODE CETAK: BUAT TABEL LEBIH RAPAT ==== */
@media print {

    /* Semua tabel rapor */
    #raporContainer table,
    #raporContainer th,
    #raporContainer td,
    #raporP5Container table,
    #raporP5Container th,
    #raporP5Container td {
        font-size: 10px !important;
        padding: 2px 3px !important;
        line-height: 1.1 !important;
    }

    #raporContainer td[colspan],
    #raporP5Container td[colspan] {
        padding: 3px !important;
    }

    #raporContainer .identity-table td,
    #raporP5Container .identity-table td {
        padding: 2px 3px !important;
        font-size: 10px !important;
    }

    #raporContainer table th {
        height: auto !important;
        white-space: normal !important;
    }
}

</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
    <h2>MENU</h2>
    <a onclick="openForm()">Identitas Sekolah</a>
    <a onclick="openSiswa()">Input Data Siswa</a>
    <a onclick="openMapel()">Pengaturan Data Sekolah</a>
    <a onclick="openInputKD()">Input KD</a>
    <a onclick="openNilai()">Input Nilai</a>
    <a onclick="openNilaiP5()">Input Nilai P5</a>
    <a onclick="openInputWaliKelas()">Input Wali Kelas</a>
    
    <!-- Dropdown Menu untuk Cetak -->
    <div class="dropdown">
        <a>Cetak</a>
        <div class="dropdown-content">
            <a onclick="openCetakRapor()">Cetak Rapor</a>
            <a onclick="openCetakRaporP5()">Cetak Rapor P5</a>
            <a onclick="openBuktiAmbilRapor()">Bukti Ambil Raport</a>
        </div>
    </div>
    
    <a onclick="openKenaikanKelas()">Kenaikan Kelas</a>
    <a onclick="openBackupRestore()">Backup & Restore Data</a>
</div>

<!-- Tombol buka/tutup -->
<button id="toggleBtn" onclick="toggleSidebar()">â˜°</button>

<!-- Halaman Konten -->
<div id="content">
    <h2>Selamat datang</h2>
    <p>Klik menu di sebelah kiri untuk membuka form.</p>
</div>

<script>
/* Utility */
function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    const btn = document.getElementById('toggleBtn');
    const content = document.getElementById('content');
    sb.classList.toggle('hidden');
    btn.classList.toggle('closed');
    content.classList.toggle('full');
}

/* ===== Identitas Sekolah ===== */
function openForm() { toggleSidebar(); loadForm(); }
function loadForm() {
    const data = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    document.getElementById('content').innerHTML = `
        <h2>Form Identitas Sekolah</h2>
        <label>Lembaga Naungan</label><input id="lembaga" value="${data.lembaga || ''}">
        <label>Nama Sekolah</label><input id="sekolah" value="${data.sekolah || ''}">
        <label>Desa</label><input id="desa" value="${data.desa || ''}">
        <label>Kecamatan</label><input id="kecamatan" value="${data.kecamatan || ''}">
        <label>Kabupaten</label><input id="kabupaten" value="${data.kabupaten || ''}">
        <label>Provinsi</label><input id="provinsi" value="${data.provinsi || ''}">
        <label>Nama Kepala Sekolah</label><input id="kepsek" value="${data.kepsek || ''}">
        <label>Logo Sekolah</label><input type="file" id="logo" accept="image/*" onchange="previewLogo(event)">
        <br><br><img id="previewImg" src="${data.logo || ''}" style="max-width:150px; display:${data.logo ? 'block':'none'}">
        <button class="btn" onclick="simpanData()">Simpan Data</button>
        <button class="btn" onclick="lihatData()">Lihat Data Tersimpan</button>
    `;
}
function previewLogo(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('previewImg'); img.src = e.target.result; img.style.display = 'block'; }; reader.readAsDataURL(file); }
function simpanData() {
    const logoFile = document.getElementById('logo').files[0];
    const currentData = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    const oldLogo = currentData.logo || null;
    if (logoFile) { const reader = new FileReader(); reader.onload = function(e) { saveSekolah(e.target.result); }; reader.readAsDataURL(logoFile); } else { saveSekolah(oldLogo); }
}
function saveSekolah(logo) {
    const data = { lembaga: document.getElementById('lembaga').value, sekolah: document.getElementById('sekolah').value, desa: document.getElementById('desa').value, kecamatan: document.getElementById('kecamatan').value, kabupaten: document.getElementById('kabupaten').value, provinsi: document.getElementById('provinsi').value, kepsek: document.getElementById('kepsek').value, logo: logo };
    localStorage.setItem('dataSekolah', JSON.stringify(data));
    alert('Data sekolah berhasil disimpan!'); loadForm();
}
function lihatData() {
    const data = JSON.parse(localStorage.getItem('dataSekolah'));
    if (!data) { alert('Belum ada data tersimpan.'); return; }
    document.getElementById('content').innerHTML = `
        <h2>Identitas Sekolah</h2>
        <p><b>Lembaga:</b> ${data.lembaga || '-'}</p><p><b>Sekolah:</b> ${data.sekolah || '-'}</p><p><b>Desa:</b> ${data.desa || '-'}</p><p><b>Kecamatan:</b> ${data.kecamatan || '-'}</p><p><b>Kabupaten:</b> ${data.kabupaten || '-'}</p><p><b>Provinsi:</b> ${data.provinsi || '-'}</p><p><b>Kepala Sekolah:</b> ${data.kepsek || '-'}</p>
        ${data.logo ? `<img src="${data.logo}" width="120">` : '<i>Tidak ada logo</i>'}
        <br><br><button class="btn" onclick="loadForm()">Kembali ke Form</button>
    `;
}

/* ===== Data Siswa ===== */
const STUDENT_DATA_HEADER = ["URUT","NISN","NAMA","JK","TEMPAT LAHIR","TANGGAL LAHIR","AYAH","IBU","ALAMAT","KELAS", "JURUSAN"];
function openSiswa() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const uniqueKelasSet = new Set();
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    if (allSiswaData.length > 1) { allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } }); }
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let filterOptions = '<option value="all">Semua Kelas</option>';
    uniqueKelasArray.forEach(kelas => { filterOptions += `<option value="${kelas}">${kelas}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Data Siswa</h2>
        <p>Unduh template, isi data, lalu unggah file tersebut. Pastikan struktur kolom tidak diubah.</p>
        <button class="btn" onclick="downloadTemplate()">1. Unduh Template</button>
        <br>
        <label>2. Unggah File Excel (.xlsx)</label>
        <input type='file' id='uploadExcel' accept='.xlsx,.xls' onchange='uploadSiswa(event)'>
        <br>
        <button class="btn" onclick="simpanDataSiswa()">3. Simpan Data ke Aplikasi</button>
        <p style="color: red; margin-top: 10px;">Perhatian: Menyimpan data baru akan menggantikan semua data siswa yang ada!</p>
        <hr style="margin: 20px 0;">
        <label for="filterKelas">Filter Berdasarkan Kelas</label>
        <select id="filterKelas" onchange="filterSiswaByKelas()">${filterOptions}</select>
        <div id='tabelSiswa'></div>
    `;
    if (allSiswaData.length > 0) { renderSiswaTableFromArray(allSiswaData); } else { document.getElementById('tabelSiswa').innerHTML = '<p>Belum ada data siswa yang disimpan.</p>'; }
}
function downloadTemplate() { const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([STUDENT_DATA_HEADER]); XLSX.utils.book_append_sheet(wb, ws, "TemplateSiswa"); XLSX.writeFile(wb, "template_siswa.xlsx"); }
function uploadSiswa(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, {header:1});
            if (json.length === 0) { alert('File Excel kosong.'); document.getElementById('uploadExcel').value = ''; return; }
            const uploadedHeader = json[0].map(h => String(h).trim().toUpperCase());
            const officialHeader = STUDENT_DATA_HEADER.map(h => h.toUpperCase());
            if (JSON.stringify(uploadedHeader) !== JSON.stringify(officialHeader)) { alert(`Struktur kolom tidak sesuai template!\n\nHarap gunakan template yang telah diunduh.\n\nKolom yang diharapkan: ${STUDENT_DATA_HEADER.join(', ')}`); document.getElementById('uploadExcel').value = ''; return; }
            window.tempDataSiswa = json;
            renderSiswaTableFromArray(json);
        } catch (error) { alert('Gagal membaca file. Pastikan file adalah Excel (.xlsx) dan tidak rusak.'); console.error(error); document.getElementById('uploadExcel').value = ''; }
    };
    reader.readAsArrayBuffer(file);
}
function simpanDataSiswa() {
    if (!window.tempDataSiswa || window.tempDataSiswa.length === 0) { alert('Tidak ada data yang diupload. Silakan unggah file Excel terlebih dahulu.'); return; }
    const isConfirmed = confirm('Apakah Anda yakin ingin mengganti semua data siswa yang ada dengan data baru? Data lama akan hilang.');
    if (!isConfirmed) { return; }
    localStorage.setItem('dataSiswa', JSON.stringify(window.tempDataSiswa));
    alert('Data siswa berhasil diperbarui!'); window.tempDataSiswa = null; document.getElementById('uploadExcel').value = ''; openSiswa();
}
function filterSiswaByKelas() {
    const selectedKelas = document.getElementById('filterKelas').value;
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (selectedKelas === 'all' || allSiswaData.length <= 1) { renderSiswaTableFromArray(allSiswaData); return; }
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const filteredRows = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === selectedKelas);
    const filteredData = [STUDENT_DATA_HEADER, ...filteredRows];
    renderSiswaTableFromArray(filteredData);
}
function renderSiswaTableFromArray(array2d) {
    const container = document.getElementById('tabelSiswa');
    if (!array2d || array2d.length === 0) { container.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>'; return; }
    const header = STUDENT_DATA_HEADER; const rows = array2d.slice(1);
    let html = '<table><tr>';
    header.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr>';
    for (let r of rows) {
        html += '<tr>';
        for (let i=0; i < header.length; i++) { const cell = r[i] !== undefined ? r[i] : ''; html += `<td>${cell}</td>`; }
        html += '</tr>';
    }
    html += '</table>';
    container.innerHTML = html;
}

/* ===== Mata Pelajaran & Jurusan & Ekstrakurikuler (DIGABUNGKAN) ===== */
function openMapel() {
    toggleSidebar();
    const defaultMapel = ["Al Qur'an Hadist","Akidah Akhlak","Fikih","Sejarah Kebudayaan Islam","Pendidikan Kewarganegaraan","Bahasa Indonesia","Bahasa Arab","Bahasa Inggris","Matematika","Sejarah Indonesia","Seni Budaya","Pend. Jasmani Olahraga dan Kesehatan","Prakarya Dan Kewirausahaan","Fisika"];
    const defaultJurusan = ["UMUM", "ILMU SOSIAL", "ILMU ALAM"];
    
    let mapelSaved; try { mapelSaved = JSON.parse(localStorage.getItem('mapel')) || defaultMapel; } catch (e) { console.error("Gagal memuat data mapel dari localStorage, menggunakan data default.", e); mapelSaved = defaultMapel; }
    let jurusanSaved; try { jurusanSaved = JSON.parse(localStorage.getItem('jurusan')) || defaultJurusan; } catch (e) { console.error("Gagal memuat data jurusan, menggunakan data default.", e); jurusanSaved = defaultJurusan; }
    let ekstraSaved; try { ekstraSaved = JSON.parse(localStorage.getItem('ekstrakurikuler')) || []; } catch (e) { console.error("Gagal memuat data ekstrakurikuler, menggunakan array kosong.", e); ekstraSaved = []; }

    let mapelList = ''; mapelSaved.forEach((m,i)=>{ mapelList += `<li>${m} <button class='btn btn-delete' onclick='hapusMapel(${i})'>Hapus</button></li>`; });
    let jurusanList = ''; jurusanSaved.forEach((j,i)=>{ jurusanList += `<li>${j} <button class='btn btn-delete' onclick='hapusJurusan(${i})'>Hapus</button></li>`; });
    let ekstraList = ''; ekstraSaved.forEach((e,i)=>{ ekstraList += `<li>${e} <button class='btn btn-delete' onclick='hapusEkstra(${i})'>Hapus</button></li>`; });

    document.getElementById('content').innerHTML = `
        <h2>Pengaturan Data Sekolah</h2>
        
        <div class="input-master-container">
            <div class="input-group">
                <label>Mata Pelajaran</label>
                <input id='mapelBaru' placeholder='Nama mapel baru'>
                <button class='btn' onclick='tambahMapel()'>Simpan</button>
            </div>
            <div class="input-group">
                <label>Jurusan</label>
                <input id='jurusanBaru' placeholder='Nama jurusan baru'>
                <button class='btn' onclick='tambahJurusan()'>Simpan</button>
            </div>
            <div class="input-group">
                <label>Ekstrakurikuler</label>
                <input id='ekstraBaru' placeholder='Nama kegiatan baru'>
                <button class='btn' onclick='tambahEkstra()'>Simpan</button>
            </div>
        </div>

        <h3>Daftar Mata Pelajaran</h3>
        <ul id='mapelList'>${mapelList}</ul>
        
        <h3>Daftar Jurusan</h3>
        <ul id='jurusanList'>${jurusanList}</ul>
        
        <h3>Daftar Ekstrakurikuler</h3>
        <ul id='ekstraList'>${ekstraList}</ul>
    `;
}
function tambahMapel() {
    const input = document.getElementById('mapelBaru').value.trim(); if (!input) return alert('Isi nama mapel terlebih dahulu.');
    let saved; try { saved = JSON.parse(localStorage.getItem('mapel')) || []; } catch (e) { console.error("Gagal memuat data mapel saat menambah, menggunakan array kosong.", e); saved = []; }
    if(saved.includes(input)) { alert(`Mata pelajaran "${input}" sudah ada di daftar.`); return; }
    saved.push(input); localStorage.setItem('mapel', JSON.stringify(saved));
    alert(`Mata pelajaran "${input}" berhasil ditambahkan.`); openMapel();
}
function hapusMapel(i) {
    if (confirm('Apakah Anda yakin ingin menghapus mata pelajaran ini?')) {
        let saved; try { saved = JSON.parse(localStorage.getItem('mapel')) || []; } catch (e) { console.error("Gagal memuat data mapel saat menghapus, menggunakan array kosong.", e); saved = []; }
        const deletedItem = saved[i]; saved.splice(i,1); localStorage.setItem('mapel', JSON.stringify(saved));
        alert(`Mata pelajaran "${deletedItem}" berhasil dihapus.`); openMapel();
    }
}
function tambahJurusan() {
    const input = document.getElementById('jurusanBaru').value.trim(); if (!input) return alert('Isi nama jurusan terlebih dahulu.');
    let saved; try { saved = JSON.parse(localStorage.getItem('jurusan')) || []; } catch (e) { console.error("Gagal memuat data jurusan saat menambah, menggunakan array kosong.", e); saved = []; }
    if(saved.includes(input)) { alert(`Jurusan "${input}" sudah ada di daftar.`); return; }
    saved.push(input); localStorage.setItem('jurusan', JSON.stringify(saved));
    alert(`Jurusan "${input}" berhasil ditambahkan.`); openMapel();
}
function hapusJurusan(i) {
    if (confirm('Apakah Anda yakin ingin menghapus jurusan ini?')) {
        let saved; try { saved = JSON.parse(localStorage.getItem('jurusan')) || []; } catch (e) { console.error("Gagal memuat data jurusan saat menghapus, menggunakan array kosong.", e); saved = []; }
        const deletedItem = saved[i]; saved.splice(i,1); localStorage.setItem('jurusan', JSON.stringify(saved));
        alert(`Jurusan "${deletedItem}" berhasil dihapus.`); openMapel();
    }
}
function tambahEkstra() {
    const input = document.getElementById('ekstraBaru').value.trim();
    if (!input) return alert('Isi nama kegiatan ekstrakurikuler terlebih dahulu.');
    let saved;
    try { saved = JSON.parse(localStorage.getItem('ekstrakurikuler')) || []; } catch (e) { console.error("Gagal memuat data ekstrakurikuler saat menambah, menggunakan array kosong.", e); saved = []; }
    if(saved.includes(input)) { alert(`Kegiatan "${input}" sudah ada di daftar.`); return; }
    saved.push(input);
    localStorage.setItem('ekstrakurikuler', JSON.stringify(saved));
    alert(`Kegiatan ekstrakurikuler "${input}" berhasil ditambahkan.`);
    openMapel();
}
function hapusEkstra(i) {
    if (confirm('Apakah Anda yakin ingin menghapus kegiatan ekstrakurikuler ini?')) {
        let saved;
        try { saved = JSON.parse(localStorage.getItem('ekstrakurikuler')) || []; } catch (e) { console.error("Gagal memuat data ekstrakurikuler saat menghapus, menggunakan array kosong.", e); saved = []; }
        const deletedItem = saved[i];
        saved.splice(i, 1);
        localStorage.setItem('ekstrakurikuler', JSON.stringify(saved));
        alert(`Kegiatan "${deletedItem}" berhasil dihapus.`);
        openMapel();
    }
}

/* ===== Input KD (Kompetensi Dasar) ===== */
function openInputKD() {
    toggleSidebar();
    
    // Ambil data mapel dari localStorage
    let mapelData;
    try { 
        mapelData = JSON.parse(localStorage.getItem('mapel')) || []; 
    } catch(e) { 
        console.error("Gagal memuat data mapel untuk halaman KD, menggunakan array kosong.", e); 
        mapelData = []; 
    }
    
    // Ambil data KD dari localStorage
    let kdData;
    try { 
        kdData = JSON.parse(localStorage.getItem('dataKD')) || {}; 
    } catch(e) { 
        console.error("Gagal memuat data KD, menggunakan objek kosong.", e); 
        kdData = {}; 
    }
    
    // Buat tabel input KD
    let tableRows = '';
    mapelData.forEach((mapel, index) => {
        const mapelKD = kdData[mapel] || { materi1: '', materi2: '' };
        tableRows += `
            <tr>
                <td>${index + 1}</td>
                <td>${mapel}</td>
                <td><input type="text" id="materi1_${index}" value="${mapelKD.materi1}" placeholder="Input materi 1"></td>
                <td><input type="text" id="materi2_${index}" value="${mapelKD.materi2}" placeholder="Input materi 2"></td>
            </tr>
        `;
    });
    
    document.getElementById('content').innerHTML = `
        <h2>Input Kompetensi Dasar (KD)</h2>
        <p>Inputkan deskripsi materi untuk setiap mata pelajaran. Data ini akan digunakan pada laporan rapor.</p>
        
        <table id="kdTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Mata Pelajaran</th>
                    <th>Materi 1</th>
                    <th>Materi 2</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        
        <button class="btn" onclick="simpanDataKD()">Simpan Data KD</button>
    `;
}

function simpanDataKD() {
    // Ambil data mapel dari localStorage
    let mapelData;
    try { 
        mapelData = JSON.parse(localStorage.getItem('mapel')) || []; 
    } catch(e) { 
        console.error("Gagal memuat data mapel saat menyimpan KD, menggunakan array kosong.", e); 
        mapelData = []; 
    }
    
    // Buat objek untuk menyimpan data KD
    const kdData = {};
    
    // Ambil nilai dari input dan simpan ke objek
    mapelData.forEach((mapel, index) => {
        const materi1 = document.getElementById(`materi1_${index}`).value.trim();
        const materi2 = document.getElementById(`materi2_${index}`).value.trim();
        
        kdData[mapel] = {
            materi1: materi1,
            materi2: materi2
        };
    });
    
    // Simpan ke localStorage
    localStorage.setItem('dataKD', JSON.stringify(kdData));
    
    alert('Data Kompetensi Dasar berhasil disimpan!');
}

/* ===== Input Nilai ===== */
function openNilai() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    let mapelData; try { mapelData = JSON.parse(localStorage.getItem('mapel')) || []; } catch(e) { console.error("Gagal memuat data mapel untuk halaman nilai, menggunakan array kosong.", e); mapelData = []; }
    if (allSiswaData.length <= 1) { document.getElementById('content').innerHTML = `<h2>Input Nilai</h2><p>Belum ada data siswa. Silakan input data siswa terlebih dahulu.</p>`; return; }
    if (mapelData.length === 0) { document.getElementById('content').innerHTML = `<h2>Input Nilai</h2><p>Belum ada mata pelajaran. Silakan input mata pelajaran terlebih dahulu.</p>`; return; }
    const uniqueKelasSet = new Set(); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Input Nilai</h2>
        <div class="semester-container">
            <div><label for="pilihKelasNilai">Pilih Kelas</label><select id="pilihKelasNilai" onchange="showKelasNilaiPage()">${kelasOptions}</select></div>
            <div><label for="pilihSemesterNilai">Pilih Semester</label><select id="pilihSemesterNilai" onchange="showKelasNilaiPage()"><option value="">-- Pilih Semester --</option><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
        </div>
        <div id="nilaiContent"></div>
    `;
}
function showKelasNilaiPage() {
    const kelasName = document.getElementById('pilihKelasNilai').value;
    const semester = document.getElementById('pilihSemesterNilai').value;
    const contentDiv = document.getElementById('nilaiContent');
    if (!kelasName || !semester) { contentDiv.innerHTML = ''; return; }
    let mapelData; try { mapelData = JSON.parse(localStorage.getItem('mapel')) || []; } catch(e) { console.error("Gagal memuat data mapel untuk halaman nilai kelas, menggunakan array kosong.", e); mapelData = []; }
    const allNilaiData = JSON.parse(localStorage.getItem('dataNilai')) || {};
    const existingNilai = allNilaiData[`${kelasName}_${semester}`] || null;
    contentDiv.innerHTML = `
        <h3>Input Nilai - Kelas ${kelasName} Semester ${semester}</h3>
        <button class="btn" onclick="downloadTemplateNilai('${kelasName}', '${semester}')">Unduh Template Nilai</button>
        <br>
        <label>Unggah File Nilai (.xlsx)</label>
        <input type='file' id='uploadNilai' accept='.xlsx,.xls' onchange='uploadNilai(event, "${kelasName}", "${semester}")'>
        <br>
        <button class="btn" onclick="simpanDataNilai('${kelasName}', '${semester}')">Simpan Data Nilai</button>
        <div id='tabelNilai'></div>
    `;
    if (existingNilai) { renderNilaiTable(existingNilai); } else { document.getElementById('tabelNilai').innerHTML = '<p>Belum ada data nilai untuk kelas dan semester ini. Silakan unduh template, isi, dan unggah kembali.</p>'; }
}
function downloadTemplateNilai(kelasName, semester) {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    let mapelData; try { mapelData = JSON.parse(localStorage.getItem('mapel')) || []; } catch(e) { console.error("Gagal memuat data mapel untuk template nilai, menggunakan array kosong.", e); mapelData = []; }
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    const header = ["no", "Nama", ...mapelData];
    const dataRows = studentsInClass.map((student, index) => { return [index + 1, student[namaIndex], ...mapelData.map(() => "")]; });
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([header, ...dataRows]);
    XLSX.utils.book_append_sheet(wb, ws, `Nilai ${kelasName} ${semester}`); XLSX.writeFile(wb, `template_nilai_${kelasName}_${semester}.xlsx`);
}
function uploadNilai(event, kelasName, semester) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, {header:1});
            if (json.length === 0) { alert('File Excel kosong.'); document.getElementById('uploadNilai').value = ''; return; }
            window.tempDataNilai = json; renderNilaiTable(json);
        } catch (error) { alert('Gagal membaca file. Pastikan file adalah Excel (.xlsx) dan tidak rusak.'); console.error(error); document.getElementById('uploadNilai').value = ''; }
    };
    reader.readAsArrayBuffer(file);
}
function simpanDataNilai(kelasName, semester) {
    if (!window.tempDataNilai || window.tempDataNilai.length === 0) { alert('Tidak ada data yang diupload. Silakan unggah file Excel terlebih dahulu.'); return; }
    let allNilaiData = JSON.parse(localStorage.getItem('dataNilai')) || {};
    allNilaiData[`${kelasName}_${semester}`] = window.tempDataNilai;
    localStorage.setItem('dataNilai', JSON.stringify(allNilaiData));
    alert(`Data nilai untuk kelas ${kelasName} semester ${semester} berhasil disimpan!`);
    window.tempDataNilai = null; document.getElementById('uploadNilai').value = ''; showKelasNilaiPage();
}
function renderNilaiTable(array2d) {
    const container = document.getElementById('tabelNilai');
    if (!array2d || array2d.length === 0) { container.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>'; return; }
    const header = array2d[0]; const rows = array2d.slice(1);
    let html = '<table class="nilai-table"><tr>';
    header.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr>';
    for (let r of rows) {
        html += '<tr>';
        for (let i=0; i<header.length; i++) { const cell = r[i] !== undefined ? r[i] : ''; html += `<td>${cell}</td>`; }
        html += '</tr>';
    }
    html += '</table>';
    container.innerHTML = html;
}

/* ===== Input Nilai P5 ===== */
const P5_DIMENSIONS = ["Beriman, Bertakwa Kepada Tuhan Yang Maha Esa, dan Berakhlak Mulia", "Berkebhinekaan Global", "Bergotong-Royong", "Mandiri", "Bernalar Kritis", "Kreatif"];
function openNilaiP5() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { document.getElementById('content').innerHTML = `<h2>Input Nilai P5</h2><p>Belum ada data siswa. Silakan input data siswa terlebih dahulu.</p>`; return; }
    const uniqueKelasSet = new Set(); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Input Nilai P5</h2>
        <div class="semester-container">
            <div><label for="pilihKelasNilaiP5">Pilih Kelas</label><select id="pilihKelasNilaiP5" onchange="showKelasNilaiPageP5()">${kelasOptions}</select></div>
            <div><label for="pilihSemesterNilaiP5">Pilih Semester</label><select id="pilihSemesterNilaiP5" onchange="showKelasNilaiPageP5()"><option value="">-- Pilih Semester --</option><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
        </div>
        <div id="nilaiContentP5"></div>
    `;
}
function showKelasNilaiPageP5() {
    const kelasName = document.getElementById('pilihKelasNilaiP5').value;
    const semester = document.getElementById('pilihSemesterNilaiP5').value;
    const contentDiv = document.getElementById('nilaiContentP5');
    if (!kelasName || !semester) { contentDiv.innerHTML = ''; return; }
    const allNilaiDataP5 = JSON.parse(localStorage.getItem('dataNilaiP5')) || {};
    const existingNilai = allNilaiDataP5[`${kelasName}_${semester}`] || null;
    contentDiv.innerHTML = `
        <h3>Input Nilai P5 - Kelas ${kelasName} Semester ${semester}</h3>
        <button class="btn" onclick="downloadTemplateNilaiP5('${kelasName}', '${semester}')">Unduh Template Nilai P5</button>
        <br>
        <label>Unggah File Nilai P5 (.xlsx)</label>
        <input type='file' id='uploadNilaiP5' accept='.xlsx,.xls' onchange='uploadNilaiP5(event, "${kelasName}", "${semester}")'>
        <br>
        <button class="btn" onclick="simpanDataNilaiP5('${kelasName}', '${semester}')">Simpan Data Nilai P5</button>
        <div id='tabelNilaiP5'></div>
    `;
    if (existingNilai) { renderNilaiTableP5(existingNilai); } else { document.getElementById('tabelNilaiP5').innerHTML = '<p>Belum ada data nilai P5 untuk kelas dan semester ini. Silakan unduh template, isi, dan unggah kembali.</p>'; }
}
function downloadTemplateNilaiP5(kelasName, semester) {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    const header = ["no", "Nama", ...P5_DIMENSIONS];
    const dataRows = studentsInClass.map((student, index) => { return [index + 1, student[namaIndex], ...P5_DIMENSIONS.map(() => "")]; });
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet([header, ...dataRows]);
    XLSX.utils.book_append_sheet(wb, ws, `Nilai P5 ${kelasName} ${semester}`); XLSX.writeFile(wb, `template_nilai_P5_${kelasName}_${semester}.xlsx`);
}
function uploadNilaiP5(event, kelasName, semester) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, {header:1});
            if (json.length === 0) { alert('File Excel kosong.'); document.getElementById('uploadNilaiP5').value = ''; return; }
            window.tempDataNilaiP5 = json; renderNilaiTableP5(json);
        } catch (error) { alert('Gagal membaca file. Pastikan file adalah Excel (.xlsx) dan tidak rusak.'); console.error(error); document.getElementById('uploadNilaiP5').value = ''; }
    };
    reader.readAsArrayBuffer(file);
}
function simpanDataNilaiP5(kelasName, semester) {
    if (!window.tempDataNilaiP5 || window.tempDataNilaiP5.length === 0) { alert('Tidak ada data yang diupload. Silakan unggah file Excel terlebih dahulu.'); return; }
    let allNilaiDataP5 = JSON.parse(localStorage.getItem('dataNilaiP5')) || {};
    allNilaiDataP5[`${kelasName}_${semester}`] = window.tempDataNilaiP5;
    localStorage.setItem('dataNilaiP5', JSON.stringify(allNilaiDataP5));
    alert(`Data nilai P5 untuk kelas ${kelasName} semester ${semester} berhasil disimpan!`);
    window.tempDataNilaiP5 = null; document.getElementById('uploadNilaiP5').value = ''; showKelasNilaiPageP5();
}
function renderNilaiTableP5(array2d) {
    const container = document.getElementById('tabelNilaiP5');
    if (!array2d || array2d.length === 0) { container.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>'; return; }
    const header = array2d[0]; const rows = array2d.slice(1);
    let html = '<table class="nilai-table"><tr>';
    header.forEach(h => { html += `<th>${h}</th>`; });
    html += '</tr>';
    for (let r of rows) {
        html += '<tr>';
        for (let i=0; i<header.length; i++) { const cell = r[i] !== undefined ? r[i] : ''; html += `<td>${cell}</td>`; }
        html += '</tr>';
    }
    html += '</table>';
    container.innerHTML = html;
}

/* ===== INPUT WALI KELAS (MENU UTAMA) ===== */
function openInputWaliKelas() {
    toggleSidebar();
    document.getElementById('content').innerHTML = `
        <h2>Input Data Wali Kelas</h2>
        <p>Pilih menu di bawah untuk menginput data terkait wali kelas.</p>
        <div class="wali-kelas-container">
            <h3>Data Absensi</h3>
            <button class="btn" onclick="openInputAbsen()">Input Absen</button>
        </div>
        <div class="wali-kelas-container">
            <h3>Data Ekstrakurikuler</h3>
            <button class="btn" onclick="openInputEkstra()">Input Ekstra</button>
        </div>
        <div class="wali-kelas-container">
            <h3>Catatan Wali Kelas</h3>
            <button class="btn" onclick="openInputCatatanWaliKelas()">Input Catatan</button>
        </div>
        <div class="wali-kelas-container">
            <h3>Wali Kelas per Rombel</h3>
            <button class="btn" onclick="openInputWaliKelasRombel()">Input Nama Wali Kelas</button>
        </div>
    `;
}

/* ===== FITUR: INPUT ABSEN ===== */
function openInputAbsen() {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { alert('Belum ada data siswa.'); return; }
    const uniqueKelasSet = new Set(); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Input Absen</h2>
        <div class="semester-container">
            <div><label for="pilihKelasAbsen">Pilih Kelas</label><select id="pilihKelasAbsen">${kelasOptions}</select></div>
            <div><label for="pilihSemesterAbsen">Pilih Semester</label><select id="pilihSemesterAbsen"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
        </div>
        <button class="btn" onclick="tampilkanFormAbsen()">Tampilkan Data Siswa</button>
        <div id="formAbsenContainer"></div>
    `;
}
function tampilkanFormAbsen() {
    const kelasName = document.getElementById('pilihKelasAbsen').value;
    const semester = document.getElementById('pilihSemesterAbsen').value;
    if (!kelasName || !semester) { alert('Pilih kelas dan semester terlebih dahulu.'); return; }
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    const allAbsenData = JSON.parse(localStorage.getItem('dataAbsen')) || {};
    const absenKey = `${kelasName}_${semester}`;
    const classAbsenData = allAbsenData[absenKey] || {};

    let formRows = '';
    studentsInClass.forEach(student => {
        const nama = student[namaIndex];
        const currentData = classAbsenData[nama] || { alpa: 0, izin: 0, sakit: 0 };
        formRows += `
            <tr>
                <td>${nama}</td>
                <td><input type="number" id="alpa_${nama}" value="${currentData.alpa}" min="0" style="width:80px;"></td>
                <td><input type="number" id="izin_${nama}" value="${currentData.izin}" min="0" style="width:80px;"></td>
                <td><input type="number" id="sakit_${nama}" value="${currentData.sakit}" min="0" style="width:80px;"></td>
            </tr>
        `;
    });

    document.getElementById('formAbsenContainer').innerHTML = `
        <h3>Data Absensi - Kelas ${kelasName} Semester ${semester}</h3>
        <table>
            <thead><tr><th>Nama</th><th>Alpa</th><th>Izin</th><th>Sakit</th></tr></thead>
            <tbody>${formRows}</tbody>
        </table>
        <button class="btn" onclick="simpanDataAbsen('${kelasName}', '${semester}')">Simpan Data Absen</button>
    `;
}
function simpanDataAbsen(kelasName, semester) {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    
    let allAbsenData = JSON.parse(localStorage.getItem('dataAbsen')) || {};
    const absenKey = `${kelasName}_${semester}`;
    allAbsenData[absenKey] = {};

    studentsInClass.forEach(student => {
        const nama = student[namaIndex];
        allAbsenData[absenKey][nama] = {
            alpa: parseInt(document.getElementById(`alpa_${nama}`).value) || 0,
            izin: parseInt(document.getElementById(`izin_${nama}`).value) || 0,
            sakit: parseInt(document.getElementById(`sakit_${nama}`).value) || 0
        };
    });

    localStorage.setItem('dataAbsen', JSON.stringify(allAbsenData));
    alert(`Data absen untuk kelas ${kelasName} semester ${semester} berhasil disimpan!`);
    openInputWaliKelas();
}

/* ===== FITUR: INPUT EKSTRAKURIKULER ===== */
function openInputEkstra() {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { alert('Belum ada data siswa.'); return; }
    const uniqueKelasSet = new Set(); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    const ekstraList = JSON.parse(localStorage.getItem('ekstrakurikuler')) || [];
    document.getElementById('content').innerHTML = `
        <h2>Input Nilai Ekstrakurikuler</h2>
        <div class="semester-container">
            <div><label for="pilihKelasEkstra">Pilih Kelas</label><select id="pilihKelasEkstra">${kelasOptions}</select></div>
            <div><label for="pilihSemesterEkstra">Pilih Semester</label><select id="pilihSemesterEkstra"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
        </div>
        <button class="btn" onclick="tampilkanFormEkstra()">Tampilkan Data Siswa</button>
        <div id="formEkstraContainer"></div>
    `;
}
function tampilkanFormEkstra() {
    const kelasName = document.getElementById('pilihKelasEkstra').value;
    const semester = document.getElementById('pilihSemesterEkstra').value;
    if (!kelasName || !semester) { alert('Pilih kelas dan semester terlebih dahulu.'); return; }
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    const allEkstraData = JSON.parse(localStorage.getItem('dataEkstra')) || {};
    const ekstraKey = `${kelasName}_${semester}`;
    const classEkstraData = allEkstraData[ekstraKey] || {};
    const ekstraList = JSON.parse(localStorage.getItem('ekstrakurikuler')) || [];
    const showCount = Math.min(3, ekstraList.length || 0) || 1;
    let table = `<table style="width:100%; border-collapse:collapse;"><thead><tr><th>Nama</th>`;
    for(let i=0;i<showCount;i++){
        table += `<th>Ekstrakurikuler ${i+1}</th><th>Nilai ${i+1}</th>`;
    }
    table += `</tr></thead><tbody>`;
    studentsInClass.forEach(row => {
        const nama = row[namaIndex];
        const saved = classEkstraData[nama] || {ekstra: [], nilai: []};
        table += `<tr><td>${nama}</td>`;
        for(let i=0;i<showCount;i++){
            const valEkstra = saved.ekstra && saved.ekstra[i] ? saved.ekstra[i] : (ekstraList[i]||'');
            const valNilai = saved.nilai && saved.nilai[i] ? saved.nilai[i] : '';
            table += `<td><input type="text" id="ekstra_${nama}_${i}" value="${valEkstra}" placeholder="Kegiatan ${i+1}"></td><td><input type="text" id="nilaiekstra_${nama}_${i}" value="${valNilai}" placeholder="Nilai"></td>`;
        }
        table += `</tr>`;
    });
    table += `</tbody></table>`;
    table += `<br><button class="btn" onclick="simpanEkstra('${kelasName}','${semester}', ${showCount})">Simpan Nilai Ekstrakurikuler</button>`;
    document.getElementById('formEkstraContainer').innerHTML = table;
}
function simpanEkstra(kelasName, semester, count){
    const allEkstraData = JSON.parse(localStorage.getItem('dataEkstra')) || {};
    const ekstraKey = `${kelasName}_${semester}`;
    allEkstraData[ekstraKey] = allEkstraData[ekstraKey] || {};
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const studentsInClass = allSiswaData.slice(1).filter(r=>String(r[kelasIndex])===kelasName);
    studentsInClass.forEach(r=>{
        const nama = r[namaIndex];
        const savedEkstra = {ekstra: [], nilai: []};
        for(let i=0;i<count;i++){
            const ek = document.getElementById(`ekstra_${nama}_${i}`) ? document.getElementById(`ekstra_${nama}_${i}`).value : '';
            const ni = document.getElementById(`nilaiekstra_${nama}_${i}`) ? document.getElementById(`nilaiekstra_${nama}_${i}`).value : '';
            savedEkstra.ekstra.push(ek);
            savedEkstra.nilai.push(ni);
        }
        allEkstraData[ekstraKey][nama] = savedEkstra;
    });
    localStorage.setItem('dataEkstra', JSON.stringify(allEkstraData));
    alert('Data ekstrakurikuler berhasil disimpan.');
    openInputEkstra();
}

/* ===== FITUR: INPUT CATATAN WALI KELAS ===== */
function openInputCatatanWaliKelas() {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { alert('Belum ada data siswa.'); return; }
    const uniqueKelasSet = new Set(); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Input Catatan Wali Kelas per Siswa</h2>
        <div class="semester-container">
            <div><label for="pilihKelasCatatan">Pilih Kelas</label><select id="pilihKelasCatatan">${kelasOptions}</select></div>
            <div><label for="pilihSemesterCatatan">Pilih Semester</label><select id="pilihSemesterCatatan"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
        </div>
        <button class="btn" onclick="tampilkanFormCatatan()">Tampilkan Form</button>
        <div id="formCatatanContainer"></div>
    `;
}
function tampilkanFormCatatan() {
    const kelasName = document.getElementById('pilihKelasCatatan').value;
    const semester = document.getElementById('pilihSemesterCatatan').value;
    if (!kelasName || !semester) { alert('Pilih kelas dan semester terlebih dahulu.'); return; }
    
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);

    const allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};
    const catatanKey = `${kelasName}_${semester}`;
    const classCatatanData = allCatatanData[catatanKey] || {};

    let formRows = '';
    studentsInClass.forEach((student, index) => {
        const nama = student[namaIndex];
        const currentCatatan = classCatatanData[nama] || '';
        formRows += `
            <tr>
                <td style="text-align: center; width: 50px;">${index + 1}</td>
                <td style="width: 250px;">${nama}</td>
                <td>
                    <textarea id="catatan_${nama}" placeholder="Masukkan saran atau catatan untuk siswa ini" style="width: 100%; min-height: 60px; box-sizing: border-box;">${currentCatatan}</textarea>
                </td>
            </tr>
        `;
    });

    document.getElementById('formCatatanContainer').innerHTML = `
        <h3>Input Catatan Wali Kelas - Kelas ${kelasName} Semester ${semester}</h3>
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width: 50px;">No</th>
                    <th style="width: 250px;">Nama Siswa</th>
                    <th>Saran Wali Kelas</th>
                </tr>
            </thead>
            <tbody>
                ${formRows}
            </tbody>
        </table>
        <br>
        <button class="btn" onclick="simpanDataCatatanWaliKelas('${kelasName}', '${semester}')">Simpan Semua Catatan</button>
    `;
}
function simpanDataCatatanWaliKelas(kelasName, semester) {
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS"); const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelasName);
    
    let allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};
    const catatanKey = `${kelasName}_${semester}`;
    allCatatanData[catatanKey] = {};

    studentsInClass.forEach(student => {
        const nama = student[namaIndex];
        const catatanValue = document.getElementById(`catatan_${nama}`).value.trim();
        allCatatanData[catatanKey][nama] = catatanValue;
    });

    localStorage.setItem('dataCatatanWaliKelas', JSON.stringify(allCatatanData));
    alert(`Catatan wali kelas untuk kelas ${kelasName} semester ${semester} berhasil disimpan!`);
    openInputWaliKelas();
}

/* ===== FITUR: INPUT WALI KELAS PER ROMBEL ===== */
function openInputWaliKelasRombel(){
    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')||'{}');
    const dataSiswa = JSON.parse(localStorage.getItem('dataSiswa')||'[]');
    if(!dataSekolah.waliByClass) dataSekolah.waliByClass = {};

    let kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    let unik = new Set();
    if(kelasIndex>=0){ dataSiswa.slice(1).forEach(r=>{ if(r[kelasIndex]) unik.add(String(r[kelasIndex])); }); }
    let list = Array.from(unik).sort();

    let html = "<h2>Input Wali Kelas per Rombel</h2>";
    html += "<p>Isi nama wali kelas untuk setiap rombel. Nama ini akan muncul di rapor.</p>";

    list.forEach((k,i)=>{
        let val = dataSekolah.waliByClass[k] || "";
        html += `<div style='margin:6px 0;'>
                    <label><b>${k}</b></label><br>
                    <input id='wali_${i}' data-kelas='${k}' value='${val}' style='width:60%;padding:5px;'>
                 </div>`;
    });

    html += "<button class='btn' onclick='simpanWaliKelasRombel()'>Simpan</button>";

    document.getElementById("content").innerHTML = html;
}

function simpanWaliKelasRombel(){
    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')||'{}');
    if(!dataSekolah.waliByClass) dataSekolah.waliByClass = {};

    const inputs = document.querySelectorAll("[id^=wali_]");
    inputs.forEach(inp=>{
        let kelas = inp.dataset.kelas;
        dataSekolah.waliByClass[kelas] = inp.value.trim();
    });

    localStorage.setItem("dataSekolah", JSON.stringify(dataSekolah));
    alert("Wali kelas berhasil disimpan!");
    openInputWaliKelasRombel();
}

/* ===== CETAK RAPOR ===== */
function openCetakRapor() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { document.getElementById('content').innerHTML = `<h2>Cetak Rapor</h2><p>Belum ada data siswa. Silakan input data siswa terlebih dahulu.</p>`; return; }
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const students = allSiswaData.slice(1).map(row => ({ nama: row[namaIndex], kelas: String(row[kelasIndex]) }));
    const uniqueKelasSet = new Set(students.map(s => s.kelas));
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    let studentOptions = '<option value="">-- Pilih Siswa --</option>';
    students.forEach(s => { studentOptions += `<option value="${s.nama}">${s.nama}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Cetak Rapor</h2>
        <div class="semester-container">
            <div><label for="pilihKelasRapor">Pilih Kelas</label><select id="pilihKelasRapor" onchange="filterStudentsForRapor()">${kelasOptions}</select></div>
            <div><label for="pilihSiswaRapor">Pilih Siswa</label><select id="pilihSiswaRapor">${studentOptions}</select></div>
            <div><label for="pilihSemesterRapor">Pilih Semester</label><select id="pilihSemesterRapor" onchange="toggleKeputusanRapor()"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
            <div><label for="pilihTahunRapor">Tahun Pelajaran</label><input type="text" id="pilihTahunRapor" placeholder="Contoh: 2023/2024" value="2023/2024"></div>
        </div>
        <div id="keputusanContainer" style="display:none;">
            <label for="pilihKeputusanRapor">Keputusan</label>
            <select id="pilihKeputusanRapor"></select>
        </div>
        <button class="btn no-print" onclick="tampilkanRapor()">Tampilkan Rapor</button>
        <button class="btn no-print" onclick="backupAllRapor()">Backup PDF Semua Rapor</button>
        <button class="btn no-print" onclick="window.print()" style="display:none;" id="btnPrintRapor">Cetak</button>
        
        <div id="raporContainer"></div>
    `;
}
function filterStudentsForRapor() {
    const selectedKelas = document.getElementById('pilihKelasRapor').value;
    const studentSelect = document.getElementById('pilihSiswaRapor');
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    let studentOptions = '';
    if (selectedKelas) {
        allSiswaData.slice(1).forEach(row => { 
            if (String(row[kelasIndex]) === selectedKelas) { 
                studentOptions += `<option value="${row[namaIndex]}">${row[namaIndex]}</option>`; 
            } 
        });
    } else {
        studentOptions = '<option value="">-- Pilih Siswa --</option>';
    }
    studentSelect.innerHTML = studentOptions;
    toggleKeputusanRapor();
}
function toggleKeputusanRapor() {
    const semester = document.getElementById('pilihSemesterRapor').value;
    const kelas = document.getElementById('pilihKelasRapor').value;
    const container = document.getElementById('keputusanContainer');
    const select = document.getElementById('pilihKeputusanRapor');

    if (semester === 'genap' && kelas) {
        container.style.display = 'block';
        let options = '';
        if (kelas.includes('X')) {
            options = '<option value="Naik">Naik</option><option value="Tidak">Tidak Naik</option>';
        } else if (kelas.includes('XI')) {
            options = '<option value="Naik">Naik</option><option value="Tidak">Tidak Naik</option>';
        } else if (kelas.includes('XII')) {
            options = '<option value="Lulus">Lulus</option><option value="Tidak">Tidak Lulus</option>';
        }
        select.innerHTML = options;
    } else {
        container.style.display = 'none';
    }
}
function tampilkanRapor() {
    const selectedSiswa = document.getElementById('pilihSiswaRapor').value.trim();
    const selectedKelas = document.getElementById('pilihKelasRapor').value;
    const selectedSemester = document.getElementById('pilihSemesterRapor').value;
    const selectedTahun = document.getElementById('pilihTahunRapor').value;
    if (!selectedSiswa || !selectedKelas || !selectedSemester || !selectedTahun) { alert('Mohon lengkapi semua pilihan.'); return; }
    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const mapelData = JSON.parse(localStorage.getItem('mapel')) || [];
    const allNilaiData = JSON.parse(localStorage.getItem('dataNilai')) || {};
    const allAbsenData = JSON.parse(localStorage.getItem('dataAbsen')) || {};
    const allEkstraData = JSON.parse(localStorage.getItem('dataEkstra')) || {};
    const allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};
    const kdData = JSON.parse(localStorage.getItem('dataKD')) || {};

    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const nisnIndex = STUDENT_DATA_HEADER.indexOf("NISN"); const alamatIndex = STUDENT_DATA_HEADER.indexOf("ALAMAT"); const ayahIndex = STUDENT_DATA_HEADER.indexOf("AYAH"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    let siswaDetail = {};
    for (let row of allSiswaData.slice(1)) {
        if (row[namaIndex] && row[namaIndex].trim() === selectedSiswa) {
            siswaDetail = { nama: row[namaIndex].trim(), nisn: row[nisnIndex], alamat: row[alamatIndex], ayah: row[ayahIndex], kelas: row[kelasIndex] };
            break;
        }
    }

    const nilaiKey = `${selectedKelas}_${selectedSemester}`;
    const nilaiData = allNilaiData[nilaiKey] || []; let nilaiSiswa = {};
    if (nilaiData.length > 0) { const headerNilai = nilaiData[0]; const namaKolomIndex = headerNilai.findIndex(h => String(h).toLowerCase() === 'nama'); const siswaRow = nilaiData.slice(1).find(r => r[namaKolomIndex] && r[namaKolomIndex].trim() === selectedSiswa); if (siswaRow) { headerNilai.forEach((h, i) => { if (i > 1) { nilaiSiswa[h] = siswaRow[i]; } }); } }
    
    const absenSiswa = allAbsenData[nilaiKey] && allAbsenData[nilaiKey][selectedSiswa] ? allAbsenData[nilaiKey][selectedSiswa] : { alpa: 0, izin: 0, sakit: 0 };
    const ekstraSiswa = allEkstraData[nilaiKey] && allEkstraData[nilaiKey][selectedSiswa] ? allEkstraData[nilaiKey][selectedSiswa] : { ekstra: [], nilai: [] };
    const catatanWaliKelas = allCatatanData[nilaiKey] ? (allCatatanData[nilaiKey][selectedSiswa] || '') : '';
    
    const keputusanSelect = document.getElementById('pilihKeputusanRapor');
    const keputusan = keputusanSelect ? keputusanSelect.value : null;

    renderRapor(dataSekolah, siswaDetail, mapelData, nilaiSiswa, selectedSemester, selectedTahun, absenSiswa, ekstraSiswa, catatanWaliKelas, keputusan, kdData);
    document.getElementById('btnPrintRapor').style.display = 'inline-block';
}

function getWaliKelasByClass(kelas, dataSekolah) {
    if (!dataSekolah.waliByClass) return "............................";
    kelas = kelas.toUpperCase();
    return dataSekolah.waliByClass[kelas] || "............................";
}

function renderRapor(sekolah, siswa, mapel, nilai, semester, tahun, absen, ekstra, catatanWali, keputusan, kdData) {
    const container = document.getElementById('raporContainer');
    
    // Fungsi untuk mendapatkan deskripsi KD
    const getDeskripsiKD = (mapelName, rowIndex) => {
        if (!kdData || !kdData[mapelName]) return '';
        
        if (rowIndex === 0) { // Materi 1
            return kdData[mapelName].materi1 || '';
        } else { // Materi 2
            return kdData[mapelName].materi2 || '';
        }
    };
    
    let mapelRows = ''; let no = 1;
    mapel.forEach(m => { 
        const val = nilai[m] || 0; 
        const desc1 = getDeskripsiKD(m, 0); // Materi 1
        const desc2 = getDeskripsiKD(m, 1); // Materi 2
        
        mapelRows += `<tr>
            <td style="text-align:center; width:30px;" rowspan="2">${no++}</td>
            <td style="width:150px;" rowspan="2">${m}</td>
            <td style="text-align:center; width:50px;" rowspan="2">${val}</td>
            <td>${`Ananda ${siswa.nama} telah menguasai seluruh materi pembelajaran pokok tentang ${desc1 || m}`}</td>
        </tr>
        <tr>
       <td>${`Ananda ${siswa.nama} telah menguasai seluruh materi pembelajaran pokok tentang ${desc2 || m}`}</td>
        </tr>`; 
    });

    let ekstraRows = '';
    if (ekstra.ekstra && Array.isArray(ekstra.ekstra)) {
        ekstra.ekstra.forEach((e, i) => {
            if (e) {
                const nilai = ekstra.nilai && ekstra.nilai[i] ? ekstra.nilai[i] : '-';
                ekstraRows += `<tr><td>${e}</td><td>${nilai}</td></tr>`;
            }
        });
    }
    if (!ekstraRows) {
        ekstraRows = `<tr><td>-</td><td>-</td></tr>`;
    }

    let keputusanHtml = '';
    if (semester === 'genap' && keputusan) {
        let keputusanText = '';
        if (siswa.kelas.includes('X')) keputusanText = `${keputusan} Ke Kelas XI (Sebelas)`;
        else if (siswa.kelas.includes('XI')) keputusanText = `${keputusan} Ke Kelas XII (Dua Belas)`;
        else if (siswa.kelas.includes('XII')) keputusanText = `${keputusan}`;
        
        keputusanHtml = `<p style="text-align: center; margin-top: 10px;"><strong>Berdasarkan Hasil Penilaian Pada Semester Ini Maka dinyatakan :</strong><br><strong>${keputusanText}</strong></p>`;
    }

    container.innerHTML = `
        <h2 style="text-align: center; margin: 30px 0 20px 0; font-size: 18px; text-decoration: underline;">LEMBAR CAPAIAN PENILAIAN RAPORT</h2>
        <table class="identity-table"><tr><td>Nama Peserta Didik</td><td>: ${siswa.nama}</td></tr><tr><td>NISN</td><td>: ${siswa.nisn}</td></tr><tr><td>Sekolah</td><td>: ${sekolah.sekolah}</td></tr><tr><td>Alamat</td><td>: ${siswa.alamat}</td></tr><tr><td>Kelas</td><td>: ${siswa.kelas}</td></tr><tr><td>Semester</td><td>: ${semester}</td></tr><tr><td>Tahun Pelajaran</td><td>: ${tahun}</td></tr><tr><td>Tanggal Rapor</td><td>: ${new Date().toLocaleDateString('id-ID')}</td></tr></table>
        
        <table><thead><tr><th colspan="4">CAPAIAN KOMPETENSI MUATAN PELAJARAN</th></tr><tr><th style="width:30px;">No</th><th style="width:150px;">Mata Pelajaran</th><th style="width:50px;">Nilai</th><th>Deskripsi Capaian Pembelajaran</th></tr></thead><tbody>${mapelRows}</tbody></table>
        
        <table><thead><tr><th colspan="2">Ketidakhadiran</th></tr></thead><tbody><tr><td>Sakit</td><td>${absen.sakit}</td></tr><tr><td>Izin</td><td>${absen.izin}</td></tr><tr><td>Tanpa Keterangan</td><td>${absen.alpa}</td></tr></tbody></table>
        <table><thead><tr><th colspan="2">Kegiatan Ekstrakurikuler</th></tr></thead><tbody>${ekstraRows}</tbody></table>
        
        <table><thead><tr><th>Catatan Wali Kelas</th></tr></thead><tbody><tr><td>${catatanWali.replace(/\n/g, '<br>')}</td></tr></tbody></table>

        ${keputusanHtml}

        <div class="signatures">
            <div class="signature-box"><p>Mengetahui,<br>Kepala Sekolah</p><p><strong>${sekolah.kepsek || '............................'}</strong><br>NIP. </p></div>
            <<div class="signature-box">
    <p>Wali Kelas</p>
    <p><strong>${getWaliKelasByClass(siswa.kelas, sekolah)}</strong><br>NIP. </p>
</div>
          <div class="signature-box">
    <p>${siswa.kelas}, ${new Date().toLocaleDateString('id-ID')}</p> <!-- TANGGAL DIPINDAH KE SINI -->
    <p>Orang Tua/Wali,</p>
    <p><strong>${siswa.ayah || '............................'}</strong></p>
</div>
        </div>
    `;
}

function backupAllRapor() {
    const selectedKelas = document.getElementById('pilihKelasRapor').value;
    const selectedSemester = document.getElementById('pilihSemesterRapor').value;
    const selectedTahun = document.getElementById('pilihTahunRapor').value;
    if (!selectedKelas || !selectedSemester || !selectedTahun) { alert('Mohon lengkapi pilihan kelas, semester, dan tahun pelajaran terlebih dahulu.'); return; }

    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const mapelData = JSON.parse(localStorage.getItem('mapel')) || [];
    const allNilaiData = JSON.parse(localStorage.getItem('dataNilai')) || {};
    const allAbsenData = JSON.parse(localStorage.getItem('dataAbsen')) || {};
    const allEkstraData = JSON.parse(localStorage.getItem('dataEkstra')) || {};
    const allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};
    const kdData = JSON.parse(localStorage.getItem('dataKD')) || {};
    
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === selectedKelas);
    
    let allRaporHtml = '<!DOCTYPE html><html><head><title>Backup Rapor</title>';
    allRaporHtml += `<style>body{font-family:Times New Roman, serif;} table{width:100%; border-collapse: collapse; margin: 15px 0; font-size: 11px;} table, th, td {border: 1px solid black;} th, td {padding: 6px; vertical-align: top; text-align: left;} th {text-align: center; background-color: #f2f2f2;} .identity-table{border:none;} .identity-table td{border:none;} h2{text-align:center;} .signatures {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;   /* sejajarkan semua kolom dari atas */
    margin-top: 30px;          /* bisa Anda sesuaikan */
    font-size: 12px;
}

.signature-box {
    text-align: center;
    width: 30%;
    margin-top: 0;
    padding-top: 0;
} @media print{div{page-break-inside:avoid;}}
/* ==== MODE CETAK: BUAT TABEL LEBIH RAPAT ==== */
@media print {

    /* Semua tabel rapor */
    #raporContainer table,
    #raporContainer th,
    #raporContainer td,
    #raporP5Container table,
    #raporP5Container th,
    #raporP5Container td {
        font-size: 10px !important;
        padding: 2px 3px !important;
        line-height: 1.1 !important;
    }

    #raporContainer td[colspan],
    #raporP5Container td[colspan] {
        padding: 3px !important;
    }

    #raporContainer .identity-table td,
    #raporP5Container .identity-table td {
        padding: 2px 3px !important;
        font-size: 10px !important;
    }

    #raporContainer table th {
        height: auto !important;
        white-space: normal !important;
    }
}

</style>`;
    allRaporHtml += '</head><body>';

    studentsInClass.forEach((student, index) => {
        const siswaDetail = { nama: student[STUDENT_DATA_HEADER.indexOf("NAMA")], nisn: student[STUDENT_DATA_HEADER.indexOf("NISN")], alamat: student[STUDENT_DATA_HEADER.indexOf("ALAMAT")], ayah: student[STUDENT_DATA_HEADER.indexOf("AYAH")], kelas: student[kelasIndex] };
        const nilaiKey = `${selectedKelas}_${selectedSemester}`;
        const nilaiData = allNilaiData[nilaiKey] || []; let nilaiSiswa = {};
        if (nilaiData.length > 0) { const headerNilai = nilaiData[0]; const namaKolomIndex = headerNilai.findIndex(h => String(h).toLowerCase() === 'nama'); const siswaRow = nilaiData.slice(1).find(r => r[namaKolomIndex] && r[namaKolomIndex].trim() === siswaDetail.nama); if (siswaRow) { headerNilai.forEach((h, i) => { if (i > 1) { nilaiSiswa[h] = siswaRow[i]; } }); } }
        const absenSiswa = allAbsenData[nilaiKey] && allAbsenData[nilaiKey][siswaDetail.nama] ? allAbsenData[nilaiKey][siswaDetail.nama] : { alpa: 0, izin: 0, sakit: 0 };
        const ekstraSiswa = allEkstraData[nilaiKey] && allEkstraData[nilaiKey][siswaDetail.nama] ? allEkstraData[nilaiKey][siswaDetail.nama] : { ekstra: [], nilai: [] };
        const catatanWaliKelas = allCatatanData[nilaiKey] ? (allCatatanData[nilaiKey][siswaDetail.nama] || '') : '';
        
        const raporHtml = renderRaporToString(dataSekolah, siswaDetail, mapelData, nilaiSiswa, selectedSemester, selectedTahun, absenSiswa, ekstraSiswa, catatanWaliKelas, null, kdData);
        allRaporHtml += raporHtml;
        if (index < studentsInClass.length - 1) {
            allRaporHtml += '<div style="page-break-after: always;"></div>';
        }
    });

    allRaporHtml += '</body></html>';
    
    const newWindow = window.open();
    newWindow.document.write(allRaporHtml);
    newWindow.document.close();
    newWindow.focus();
    setTimeout(() => { newWindow.print(); }, 500);
}
function renderRaporToString(sekolah, siswa, mapel, nilai, semester, tahun, absen, ekstra, catatanWali, keputusan, kdData) {
    // Fungsi untuk mendapatkan deskripsi KD
    const getDeskripsiKD = (mapelName, rowIndex) => {
        if (!kdData || !kdData[mapelName]) return '';
        
        if (rowIndex === 0) { // Materi 1
            return kdData[mapelName].materi1 || '';
        } else { // Materi 2
            return kdData[mapelName].materi2 || '';
        }
    };
    
    let mapelRows = ''; let no = 1;
    mapel.forEach(m => { 
        const val = nilai[m] || 0; 
        const desc1 = getDeskripsiKD(m, 0); // Materi 1
        const desc2 = getDeskripsiKD(m, 1); // Materi 2
        
        mapelRows += `<tr><td style="text-align:center; width:30px;" rowspan="2">${no++}</td><td style="width:150px;" rowspan="2">${m}</td><td style="text-align:center; width:50px;" rowspan="2">${val}</td><td>${desc1 || `Telah menguasai seluruh materi pembelajaran pokok tentang ${m}`}</td></tr><tr><td>${desc2 || `Perlu ditambahi tentang penguasaan materi ${m}`}</td></tr>`; 
    });

    let ekstraRows = '';
    if (ekstra.ekstra && Array.isArray(ekstra.ekstra)) {
        ekstra.ekstra.forEach((e, i) => {
            if (e) {
                const nilai = ekstra.nilai && ekstra.nilai[i] ? ekstra.nilai[i] : '-';
                ekstraRows += `<tr><td>${e}</td><td>${nilai}</td></tr>`;
            }
        });
    }
    if (!ekstraRows) {
        ekstraRows = `<tr><td>-</td><td>-</td></tr>`;
    }
    
    let keputusanHtml = '';
    if (semester === 'genap' && keputusan) {
        let keputusanText = '';
        if (siswa.kelas.includes('X')) keputusanText = `${keputusan} Ke Kelas XI (Sebelas)`;
        else if (siswa.kelas.includes('XI')) keputusanText = `${keputusan} Ke Kelas XII (Dua Belas)`;
        else if (siswa.kelas.includes('XII')) keputusanText = `${keputusan}`;
        keputusanHtml = `<p style="text-align: center; margin-top: 10px;"><strong>Berdasarkan Hasil Penilaian Pada Semester Ini Maka dinyatakan :</strong><br><strong>${keputusanText}</strong></p>`;
    }
    return `
        <div style="padding: 40px; width: 210mm; min-height: 297mm; box-sizing: border-box;">
            <h2 style="text-align: center; margin: 30px 0 20px 0; font-size: 18px; text-decoration: underline;">LEMBAR CAPAIAN PENILAIAN RAPORT</h2>
            <table class="identity-table" style="width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 20px;"><tr><td style="width: 150px; font-weight: bold; border:none;">Nama Peserta Didik</td><td style="border:none;">: ${siswa.nama}</td></tr><tr><td style="border:none;">NISN</td><td style="border:none;">: ${siswa.nisn}</td></tr><tr><td style="border:none;">Sekolah</td><td style="border:none;">: ${sekolah.sekolah}</td></tr><tr><td style="border:none;">Alamat</td><td style="border:none;">: ${siswa.alamat}</td></tr><tr><td style="border:none;">Kelas</td><td style="border:none;">: ${siswa.kelas}</td></tr><tr><td style="border:none;">Semester</td><td style="border:none;">: ${semester}</td></tr><tr><td style="border:none;">Tahun Pelajaran</td><td style="border:none;">: ${tahun}</td></tr><tr><td style="border:none;">Tanggal Rapor</td><td style="border:none;">: ${new Date().toLocaleDateString('id-ID')}</td></tr></table>
            <table><thead><tr><th colspan="4">CAPAIAN KOMPETENSI MUATAN PELAJARAN</th></tr><tr><th style="width:30px;">No</th><th style="width:150px;">Mata Pelajaran</th><th style="width:50px;">Nilai</th><th>Deskripsi Capaian Pembelajaran</th></tr></thead><tbody>${mapelRows}</tbody></table>
            <table><thead><tr><th colspan="2">Ketidakhadiran</th></tr></thead><tbody><tr><td>Sakit</td><td>${absen.sakit}</td></tr><tr><td>Izin</td><td>${absen.izin}</td></tr><tr><td>Tanpa Keterangan</td><td>${absen.alpa}</td></tr></tbody></table>
            <table><thead><tr><th colspan="2">Kegiatan Ekstrakurikuler</th></tr></thead><tbody>${ekstraRows}</tbody></table>
            <table><thead><tr><th>Catatan Wali Kelas</th></tr></thead><tbody><tr><td>${catatanWali.replace(/\n/g, '<br>')}</td></tr></tbody></table>
            ${keputusanHtml}
        
            <div class="signatures"><div class="signature-box"><p>Mengetahui,<br>Kepala Sekolah</p><p><strong>${sekolah.kepsek || '............................'}</strong><br>NIP. </p></div><div class="signature-box"><p>${siswa.kelas}, ${new Date().toLocaleDateString('id-ID')}</p><p>Wali Kelas</p><p><strong>${getWaliKelasByClass(siswa.kelas, sekolah)}</strong><br>NIP. </p></div><div class="signature-box"><p>Orang Tua/Wali,</p><p><strong>${siswa.ayah || '............................'}</strong></p></div></div>
        </div>
    `;
}

/* ===== CETAK RAPOR P5 ===== */
function openCetakRaporP5() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { document.getElementById('content').innerHTML = `<h2>Cetak Rapor P5</h2><p>Belum ada data siswa. Silakan input data siswa terlebih dahulu.</p>`; return; }
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const students = allSiswaData.slice(1).map(row => ({ nama: row[namaIndex], kelas: String(row[kelasIndex]) }));
    const uniqueKelasSet = new Set(students.map(s => s.kelas));
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });
    let studentOptions = '<option value="">-- Pilih Siswa --</option>';
    students.forEach(s => { studentOptions += `<option value="${s.nama}">${s.nama}</option>`; });
    document.getElementById('content').innerHTML = `
        <h2>Cetak Rapor P5</h2>
        <div class="semester-container">
            <div><label for="pilihKelasRaporP5">Pilih Kelas</label><select id="pilihKelasRaporP5" onchange="filterStudentsForRaporP5()">${kelasOptions}</select></div>
            <div><label for="pilihSiswaRaporP5">Pilih Siswa</label><select id="pilihSiswaRaporP5">${studentOptions}</select></div>
            <div><label for="pilihSemesterRaporP5">Pilih Semester</label><select id="pilihSemesterRaporP5" onchange="toggleKeputusanRaporP5()"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
            <div><label for="pilihTahunRaporP5">Tahun Pelajaran</label><input type="text" id="pilihTahunRaporP5" placeholder="Contoh: 2023/2024" value="2023/2024"></div>
        </div>
        <div id="keputusanContainerP5" style="display:none;">
            <label for="pilihKeputusanRaporP5">Keputusan</label>
            <select id="pilihKeputusanRaporP5"></select>
        </div>
        <button class="btn no-print" onclick="tampilkanRaporP5()">Tampilkan Rapor P5</button>
        <button class="btn no-print" onclick="backupAllRaporP5()">Backup PDF Semua Rapor P5</button>
        <button class="btn no-print" onclick="window.print()" style="display:none;" id="btnPrintRaporP5">Cetak</button>
        
        <div id="raporP5Container"></div>
    `;
}
function filterStudentsForRaporP5() {
    const selectedKelas = document.getElementById('pilihKelasRaporP5').value;
    const studentSelect = document.getElementById('pilihSiswaRaporP5');
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    let studentOptions = '';
    if (selectedKelas) {
        allSiswaData.slice(1).forEach(row => { 
            if (String(row[kelasIndex]) === selectedKelas) { 
                studentOptions += `<option value="${row[namaIndex]}">${row[namaIndex]}</option>`; 
            } 
        });
    } else {
        studentOptions = '<option value="">-- Pilih Siswa --</option>';
    }
    studentSelect.innerHTML = studentOptions;
    toggleKeputusanRaporP5();
}
function toggleKeputusanRaporP5() {
    const semester = document.getElementById('pilihSemesterRaporP5').value;
    const kelas = document.getElementById('pilihKelasRaporP5').value;
    const container = document.getElementById('keputusanContainerP5');
    const select = document.getElementById('pilihKeputusanRaporP5');

    if (semester === 'genap' && kelas) {
        container.style.display = 'block';
        let options = '';
        if (kelas.includes('X')) {
            options = '<option value="Naik">Naik</option><option value="Tidak">Tidak Naik</option>';
        } else if (kelas.includes('XI')) {
            options = '<option value="Naik">Naik</option><option value="Tidak">Tidak Naik</option>';
        } else if (kelas.includes('XII')) {
            options = '<option value="Lulus">Lulus</option><option value="Tidak">Tidak Lulus</option>';
        }
        select.innerHTML = options;
    } else {
        container.style.display = 'none';
    }
}
function tampilkanRaporP5() {
    const selectedSiswa = document.getElementById('pilihSiswaRaporP5').value.trim();
    const selectedKelas = document.getElementById('pilihKelasRaporP5').value;
    const selectedSemester = document.getElementById('pilihSemesterRaporP5').value;
    const selectedTahun = document.getElementById('pilihTahunRaporP5').value;
    if (!selectedSiswa || !selectedKelas || !selectedSemester || !selectedTahun) { alert('Mohon lengkapi semua pilihan.'); return; }
    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const allNilaiP5Data = JSON.parse(localStorage.getItem('dataNilaiP5')) || {};
    const allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};

    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA"); const nisnIndex = STUDENT_DATA_HEADER.indexOf("NISN"); const alamatIndex = STUDENT_DATA_HEADER.indexOf("ALAMAT"); const ayahIndex = STUDENT_DATA_HEADER.indexOf("AYAH"); const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    let siswaDetail = {};
    for (let row of allSiswaData.slice(1)) {
        if (row[namaIndex] && row[namaIndex].trim() === selectedSiswa) {
            siswaDetail = { nama: row[namaIndex].trim(), nisn: row[nisnIndex], alamat: row[alamatIndex], ayah: row[ayahIndex], kelas: row[kelasIndex] };
            break;
        }
    }

    const nilaiKey = `${selectedKelas}_${selectedSemester}`;
    const p5Data = allNilaiP5Data[nilaiKey] || []; let p5Siswa = {};
    if (p5Data.length > 0) { const headerP5 = p5Data[0]; const namaKolomIndex = headerP5.findIndex(h => String(h).toLowerCase() === 'nama'); const siswaRow = p5Data.slice(1).find(r => r[namaKolomIndex] && r[namaKolomIndex].trim() === selectedSiswa); if (siswaRow) { headerP5.forEach((h, i) => { if (i > 1) { p5Siswa[h] = siswaRow[i]; } }); } }
    const catatanWaliKelas = allCatatanData[nilaiKey] ? (allCatatanData[nilaiKey][selectedSiswa] || '') : '';

    const keputusanSelect = document.getElementById('pilihKeputusanRaporP5');
    const keputusan = keputusanSelect ? keputusanSelect.value : null;

    renderRaporP5(dataSekolah, siswaDetail, P5_DIMENSIONS, p5Siswa, selectedSemester, selectedTahun, catatanWaliKelas, keputusan);
    document.getElementById('btnPrintRaporP5').style.display = 'inline-block';
}

function renderRaporP5(sekolah, siswa, p5Dims, p5Nilai, semester, tahun, catatanWali, keputusan) {
    const container = document.getElementById('raporP5Container');
    const getDeskripsiP5 = (dimensi, nilai) => { const descMap = { 'SB': 'Ananda berkembang dengan sangat baik dalam', 'BSH': 'Ananda berkembang sesuai harapan program dalam', 'B': 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam', 'MB': 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam' }; return descMap[nilai] || 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam'; };
    
    let p5Rows = '';
    P5_DIMENSIONS.forEach(dim => { const val = p5Nilai[dim] || 'MB'; const desc = getDeskripsiP5(dim, val); p5Rows += `<tr><td>${dim}</td><td>${desc}</td><td style="text-align:center; width:50px;">${val}</td></tr>`; });

    let keputusanHtml = '';
    if (semester === 'genap' && keputusan) {
        let keputusanText = '';
        if (siswa.kelas.includes('X')) keputusanText = `${keputusan} Ke Kelas XI (Sebelas)`;
        else if (siswa.kelas.includes('XI')) keputusanText = `${keputusan} Ke Kelas XII (Dua Belas)`;
        else if (siswa.kelas.includes('XII')) keputusanText = `${keputusan}`;
        
        keputusanHtml = `<p style="text-align: center; margin-top: 10px;"><strong>Berdasarkan Hasil Penilaian Pada Semester Ini Maka dinyatakan :</strong><br><strong>${keputusanText}</strong></p>`;
    }

    container.innerHTML = `
        <h2 style="text-align: center; margin: 30px 0 20px 0; font-size: 18px; text-decoration: underline;">LEMBAR CAPAIAN PENILAIAN RAPORT P5</h2>
        <table class="identity-table"><tr><td>Nama Peserta Didik</td><td>: ${siswa.nama}</td></tr><tr><td>NISN</td><td>: ${siswa.nisn}</td></tr><tr><td>Sekolah</td><td>: ${sekolah.sekolah}</td></tr><tr><td>Alamat</td><td>: ${siswa.alamat}</td></tr><tr><td>Kelas</td><td>: ${siswa.kelas}</td></tr><tr><td>Semester</td><td>: ${semester}</td></tr><tr><td>Tahun Pelajaran</td><td>: ${tahun}</td></tr><tr><td>Tanggal Rapor</td><td>: ${new Date().toLocaleDateString('id-ID')}</td></tr></table>
        <table><thead><tr><th colspan="3">DESKRIPSI CAPAIAN DIMENSI P5 (PROYEK PENGUATAN PROFIL PELAJAR PANCASILA)</th></tr><tr><th>Dimensi</th><th>Deskripsi</th><th style="width:50px;">Keterangan</th></tr></thead><tbody>${p5Rows}</tbody><tfoot><tr><td colspan="3"><p>Keterangan : MB = Mulai Berkembang, B = Berkembang, BSH = Berkembang Sesuai Harapan, SB = Sangat Berkembang</p></td></tr>
            </table>
    ${keputusanHtml}
   
    <div class="signatures">
        <div class="signature-box"><p>Mengetahui,<br>Kepala Sekolah</p><p><strong>${sekolah.kepsek || '............................'}</strong><br>NIP. </p></div>
        <div class="signature-box"><p>${siswa.kelas}, ${new Date().toLocaleDateString('id-ID')}</p><p>Wali Kelas</p><p><strong>${getWaliKelasByClass(siswa.kelas, sekolah)}</strong><br>NIP. </p></div>
        <div class="signature-box"><p>Orang Tua/Wali,</p><p><strong>${siswa.ayah || '............................'}</strong></p></div>
    </div>
    `;
}

function backupAllRaporP5() {
    const selectedKelas = document.getElementById('pilihKelasRaporP5').value;
    const selectedSemester = document.getElementById('pilihSemesterRaporP5').value;
    const selectedTahun = document.getElementById('pilihTahunRaporP5').value;
    if (!selectedKelas || !selectedSemester || !selectedTahun) { alert('Mohon lengkapi pilihan kelas, semester, dan tahun pelajaran terlebih dahulu.'); return; }

    const dataSekolah = JSON.parse(localStorage.getItem('dataSekolah')) || {};
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const allNilaiP5Data = JSON.parse(localStorage.getItem('dataNilaiP5')) || {};
    const allCatatanData = JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {};
    
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === selectedKelas);
    
    let allRaporHtml = '<!DOCTYPE html><html><head><title>Backup Rapor P5</title>';
    allRaporHtml += `<style>body{font-family:Times New Roman, serif;} table{width:100%; border-collapse: collapse; margin: 15px 0; font-size: 11px;} table, th, td {border: 1px solid black;} th, td {padding: 6px; vertical-align: top; text-align: left;} th {text-align: center; background-color: #f2f2f2;} .identity-table{border:none;} .identity-table td{border:none;} h2{text-align:center;} .signatures{display:flex; justify-content:space-between; margin-top:50px;} .signature-box{text-align:center; width:30%;} @media print{div{page-break-inside:avoid;}}
/* ==== MODE CETAK: BUAT TABEL LEBIH RAPAT ==== */
@media print {

    /* Semua tabel rapor */
    #raporContainer table,
    #raporContainer th,
    #raporContainer td,
    #raporP5Container table,
    #raporP5Container th,
    #raporP5Container td {
        font-size: 10px !important;
        padding: 2px 3px !important;
        line-height: 1.1 !important;
    }

    #raporContainer td[colspan],
    #raporP5Container td[colspan] {
        padding: 3px !important;
    }

    #raporContainer .identity-table td,
    #raporP5Container .identity-table td {
        padding: 2px 3px !important;
        font-size: 10px !important;
    }

    #raporContainer table th {
        height: auto !important;
        white-space: normal !important;
    }
}

</style>`;
    allRaporHtml += '</head><body>';

    studentsInClass.forEach((student, index) => {
        const siswaDetail = { nama: student[STUDENT_DATA_HEADER.indexOf("NAMA")], nisn: student[STUDENT_DATA_HEADER.indexOf("NISN")], alamat: student[STUDENT_DATA_HEADER.indexOf("ALAMAT")], ayah: student[STUDENT_DATA_HEADER.indexOf("AYAH")], kelas: student[kelasIndex] };
        const nilaiKey = `${selectedKelas}_${selectedSemester}`;
        const p5Data = allNilaiP5Data[nilaiKey] || []; let p5Siswa = {};
        if (p5Data.length > 0) { const headerP5 = p5Data[0]; const namaKolomIndex = headerP5.findIndex(h => String(h).toLowerCase() === 'nama'); const siswaRow = p5Data.slice(1).find(r => r[namaKolomIndex] && r[namaKolomIndex].trim() === siswaDetail.nama); if (siswaRow) { headerP5.forEach((h, i) => { if (i > 1) { p5Siswa[h] = siswaRow[i]; } }); } }
        const catatanWaliKelas = allCatatanData[nilaiKey] ? (allCatatanData[nilaiKey][siswaDetail.nama] || '') : '';
        
        const raporHtml = renderRaporP5ToString(dataSekolah, siswaDetail, P5_DIMENSIONS, p5Siswa, selectedSemester, selectedTahun, catatanWaliKelas, null);
        allRaporHtml += raporHtml;
        if (index < studentsInClass.length - 1) {
            allRaporHtml += '<div style="page-break-after: always;"></div>';
        }
    });

    allRaporHtml += '</body></html>';
    
    const newWindow = window.open();
    newWindow.document.write(allRaporHtml);
    newWindow.document.close();
    newWindow.focus();
    setTimeout(() => { newWindow.print(); }, 500);
}

function renderRaporP5ToString(sekolah, siswa, p5Dims, p5Nilai, semester, tahun, catatanWali, keputusan) {
    const getDeskripsiP5 = (dimensi, nilai) => { 
        const descMap = { 
            'SB': 'Ananda berkembang dengan sangat baik dalam', 
            'BSH': 'Ananda berkembang sesuai harapan program dalam', 
            'B': 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam', 
            'MB': 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam' 
        }; 
        return descMap[nilai] || 'Ananda mulai berkembang sehingga masih perlu bimbingan dalam'; 
    };
    let p5Rows = '';
    P5_DIMENSIONS.forEach(dim => { 
        const val = p5Nilai[dim] || 'MB'; 
        const desc = getDeskripsiP5(dim, val); 
        p5Rows += `<tr><td>${dim}</td><td>${desc}</td><td style="text-align:center; width:50px;">${val}</td></tr>`; 
    });
    let keputusanHtml = '';
    if (semester === 'genap' && keputusan) {
        let keputusanText = '';
        if (siswa.kelas.includes('X')) keputusanText = `${keputusan} Ke Kelas XI (Sebelas)`;
        else if (siswa.kelas.includes('XI')) keputusanText = `${keputusan} Ke Kelas XII (Dua Belas)`;
        else if (siswa.kelas.includes('XII')) keputusanText = `${keputusan}`;
        
        keputusanHtml = `<p style="text-align: center; margin-top: 10px;"><strong>Berdasarkan Hasil Penilaian Pada Semester Ini Maka dinyatakan :</strong><br><strong>${keputusanText}</strong></p>`;
    }
    return `
        <div style="padding: 40px; width: 210mm; min-height: 297mm; box-sizing: border-box;">
            <h2 style="text-align: center; margin: 30px 0 20px 0; font-size: 18px; text-decoration: underline;">LEMBAR CAPAIAN PENILAIAN RAPORT P5</h2>
            <table class="identity-table" style="width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 20px;"><tr><td style="width: 150px; font-weight: bold; border:none;">Nama Peserta Didik</td><td style="border:none;">: ${siswa.nama}</td></tr><tr><td style="border:none;">NISN</td><td style="border:none;">: ${siswa.nisn}</td></tr><tr><td style="border:none;">Sekolah</td><td style="border:none;">: ${sekolah.sekolah}</td></tr><tr><td style="border:none;">Alamat</td><td style="border:none;">: ${siswa.alamat}</td></tr><tr><td style="border:none;">Kelas</td><td style="border:none;">: ${siswa.kelas}</td></tr><tr><td style="border:none;">Semester</td><td style="border:none;">: ${semester}</td></tr><tr><td style="border:none;">Tahun Pelajaran</td><td style="border:none;">: ${tahun}</td></tr><tr><td style="border:none;">Tanggal Rapor</td><td style="border:none;">: ${new Date().toLocaleDateString('id-ID')}</td></tr></table>
            <table><thead><tr><th colspan="3">DESKRIPSI CAPAIAN DIMENSI P5 (PROYEK PENGUATAN PROFIL PELAJAR PANCASILA)</th></tr><tr><th>Dimensi</th><th>Deskripsi</th><th style="width:50px;">Keterangan</th></tr></thead><tbody>${p5Rows}</tbody><tfoot><tr><td colspan="3"><p>Keterangan : MB = Mulai Berkembang, B = Berkembang, BSH = Berkembang Sesuai Harapan, SB = Sangat Berkembang</p></td></tr></tfoot></table>
            <table><thead><tr><th>Catatan Wali Kelas</th></tr></thead><tbody><tr><td>${catatanWali.replace(/\n/g, '<br>')}</td></tr></tbody></table>
            ${keputusanHtml}
            
            <div class="signatures"><div class="signature-box"><p>Mengetahui,<br>Kepala Sekolah</p><p><strong>${sekolah.kepsek || '............................'}</strong><br>NIP. </p></div><div class="signature-box"><p>${siswa.kelas}, ${new Date().toLocaleDateString('id-ID')}</p><p>Wali Kelas</p><p><strong>${getWaliKelasByClass(siswa.kelas, sekolah)}</strong><br>NIP. </p></div><div class="signature-box"><p>Orang Tua/Wali,</p><p><strong>${siswa.ayah || '............................'}</strong></p></div></div>
        </div>
    `;
}

/* ===== BUKTI AMBIL RAPOR ===== */
function openBuktiAmbilRapor() {
    toggleSidebar();
    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    if (allSiswaData.length <= 1) { document.getElementById('content').innerHTML = `<h2>Bukti Ambil Raport</h2><p>Belum ada data siswa. Silakan input data siswa terlebih dahulu.</p>`; return; }
    
    const uniqueKelasSet = new Set();
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    allSiswaData.slice(1).forEach(row => { if (row[kelasIndex]) { uniqueKelasSet.add(row[kelasIndex]); } });
    const uniqueKelasArray = Array.from(uniqueKelasSet).sort();
    let kelasOptions = '<option value="">-- Pilih Kelas --</option>';
    uniqueKelasArray.forEach(kelas => { kelasOptions += `<option value="${kelas}">${kelas}</option>`; });

    document.getElementById('content').innerHTML = `
        <h2>Bukti Ambil Raport</h2>
        <div class="semester-container">
            <div><label for="pilihKelasBukti">Pilih Kelas</label><select id="pilihKelasBukti">${kelasOptions}</select></div>
            <div><label for="pilihSemesterBukti">Pilih Semester</label><select id="pilihSemesterBukti"><option value="ganjil">Ganjil</option><option value="genap">Genap</option></select></div>
            <div><label for="pilihTahunBukti">Tahun Pelajaran</label><input type="text" id="pilihTahunBukti" placeholder="Contoh: 2023/2024" value="2023/2024"></div>
        </div>
        <button class="btn no-print" onclick="tampilkanBuktiAmbilRapor()">Tampilkan Data</button>
        <button class="btn no-print" onclick="cetakBuktiAmbilRapor()" style="display:none;" id="btnCetakBukti">Cetak</button>
        <button class="btn no-print" onclick="simpanBuktiAmbilRapor()" style="display:none;" id="btnSimpanBukti">Simpan</button>
        <div id="buktiAmbilRaporContainer"></div>
    `;
}

function tampilkanBuktiAmbilRapor() {
    const kelas = document.getElementById('pilihKelasBukti').value;
    const semester = document.getElementById('pilihSemesterBukti').value;
    const tahun = document.getElementById('pilihTahunBukti').value;

    if (!kelas || !semester || !tahun) {
        alert('Mohon lengkapi pilihan kelas, semester, dan tahun pelajaran.');
        return;
    }

    const allSiswaData = JSON.parse(localStorage.getItem('dataSiswa')) || [];
    const allNilaiData = JSON.parse(localStorage.getItem('dataNilai')) || {};
    const mapelData = JSON.parse(localStorage.getItem('mapel')) || [];
    
    const kelasIndex = STUDENT_DATA_HEADER.indexOf("KELAS");
    const namaIndex = STUDENT_DATA_HEADER.indexOf("NAMA");
    
    const studentsInClass = allSiswaData.slice(1).filter(row => String(row[kelasIndex]) === kelas);
    const nilaiKey = `${kelas}_${semester}`;
    const nilaiData = allNilaiData[nilaiKey] || [];

    let studentsWithTotal = studentsInClass.map(student => {
        const nama = student[namaIndex];
        let totalNilai = 0;
        
        if (nilaiData.length > 0) {
            const headerNilai = nilaiData[0];
            const namaKolomIndex = headerNilai.findIndex(h => String(h).toLowerCase() === 'nama');
            const siswaRow = nilaiData.slice(1).find(r => r[namaKolomIndex] && r[namaKolomIndex].trim() === nama);
            
            if (siswaRow) {
                headerNilai.forEach((h, i) => {
                    if (i > 1) { // Skip 'no' and 'nama' columns
                        const nilai = parseInt(siswaRow[i]) || 0;
                        totalNilai += nilai;
                    }
                });
            }
        }
        
        return { nama, totalNilai };
    });

    // Sort by totalNilai descending
    studentsWithTotal.sort((a, b) => b.totalNilai - a.totalNilai);

    // Assign ranking
    studentsWithTotal.forEach((student, index) => {
        student.ranking = index + 1;
    });

    let tableRows = '';
    studentsWithTotal.forEach((student, index) => {
        tableRows += `
            <tr>
                <td>${index + 1}</td>
                <td>${student.nama}</td>
                <td>${student.totalNilai}</td>
                <td>${student.ranking}</td>
                <td style="height: 60px;"></td> <!-- Empty cell for signature -->
            </tr>
        `;
    });

    const container = document.getElementById('buktiAmbilRaporContainer');
    container.innerHTML = `
        <h3 style="text-align: center;">Bukti Ambil Raport</h3>
        <p style="text-align: center;">Kelas: ${kelas} | Semester: ${semester} | Tahun Pelajaran: ${tahun}</p>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #000; padding: 8px;">No</th>
                    <th style="border: 1px solid #000; padding: 8px;">Nama Siswa</th>
                    <th style="border: 1px solid #000; padding: 8px;">Total Nilai</th>
                    <th style="border: 1px solid #000; padding: 8px;">Ranking</th>
                    <th style="border: 1px solid #000; padding: 8px;">Tanda Tangan</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        <div style="margin-top: 40px; text-align: right;">
            <p>............................, ${new Date().toLocaleDateString('id-ID')}</p>
            <p><strong>Wali Kelas</strong></p>
            <br><br><br>
            <p><strong>${getWaliKelasByClass(kelas, JSON.parse(localStorage.getItem('dataSekolah')) || {})}</strong></p>
            <p>NIP. </p>
        </div>
    `;
    
    document.getElementById('btnCetakBukti').style.display = 'inline-block';
    document.getElementById('btnSimpanBukti').style.display = 'inline-block';
}

function simpanBuktiAmbilRapor() {
    const kelas = document.getElementById('pilihKelasBukti').value;
    const semester = document.getElementById('pilihSemesterBukti').value;
    const tahun = document.getElementById('pilihTahunBukti').value;
    
    if (!kelas || !semester || !tahun) {
        alert('Mohon lengkapi pilihan kelas, semester, dan tahun pelajaran.');
        return;
    }

    const container = document.getElementById('buktiAmbilRaporContainer');
    const buktiHtml = container.innerHTML;
    
    let allBuktiData = JSON.parse(localStorage.getItem('dataBuktiAmbilRapor')) || {};
    const buktiKey = `${kelas}_${semester}_${tahun}`;
    allBuktiData[buktiKey] = {
        kelas, semester, tahun, html: buktiHtml, savedAt: new Date().toISOString()
    };
    
    localStorage.setItem('dataBuktiAmbilRapor', JSON.stringify(allBuktiData));
    alert('Data Bukti Ambil Raport berhasil disimpan!');
}

function cetakBuktiAmbilRapor() {
    window.print();
}

/* ===== Kenaikan Kelas ===== */
function openKenaikanKelas(){
    toggleSidebar();
    document.getElementById('content').innerHTML=`
        <h2>Kenaikan Kelas</h2>
        <p>Fitur ini akan menaikkan kelas semua siswa (X -> XI, XI -> XII). Siswa kelas XII akan dihapus dari daftar.</p>
        <button class='btn' onclick='previewKenaikan()'>Tampilkan Preview Perubahan</button>
        <button class='btn' onclick='kenaikanKelas()' style="background:#d9534f;">Terapkan Kenaikan</button>
        <div id='previewKenaikan' style='margin-top:15px;'></div>
    `;
}

function previewKenaikan(){
    const data = JSON.parse(localStorage.getItem('dataSiswa'))||[];
    if(data.length<=1){alert('Tidak ada data siswa');return;}
    const header=data[0];
    const ki=header.indexOf('KELAS');
    const ni=header.indexOf('NAMA');
    let out="<table border=1 cellpadding=5><tr><th>Nama</th><th>Kelas Lama</th><th>Kelas Baru</th></tr>";
    data.slice(1).forEach(r=>{
        let old=r[ki];
        let n=r[ni]||'';
        let nu=old;
        if(/XII/i.test(old)) nu='(LULUS - dihapus)';
        else if(/\bXI\b/i.test(old)) nu=old.replace(/XI/i,'XII');
        else if(/\bX\b(?!I)/i.test(old)) nu=old.replace(/\bX\b/i,'XI');
        out+=`<tr><td>${n}</td><td>${old}</td><td>${nu}</td></tr>`;
    });
    out+="</table>";
    document.getElementById('previewKenaikan').innerHTML=out;
}

function kenaikanKelas(){
    const data = JSON.parse(localStorage.getItem('dataSiswa'))||[];
    if(data.length<=1){alert('Tidak ada data siswa');return;}
    const header=data[0];
    const ki=header.indexOf('KELAS');
    const newData=[header];
    data.slice(1).forEach(r=>{
        let k=r[ki];
        if(/XII/i.test(k)) return; // Hapus siswa kelas 12
        if(/\bXI\b/i.test(k)) r[ki]=k.replace(/XI/i,'XII');
        else if(/\bX\b(?!I)/i.test(k)) r[ki]=k.replace(/\bX\b/i,'XI');
        newData.push(r);
    });
    localStorage.setItem('dataSiswa',JSON.stringify(newData));
    alert('Kenaikan kelas berhasil diterapkan. Siswa kelas XII telah dihapus dari data.');
    openKenaikanKelas();
}

/* ===== FITUR: BACKUP & RESTORE DATA ===== */
function openBackupRestore() {
    toggleSidebar();
    document.getElementById('content').innerHTML = `
        <h2>Backup & Restore Data</h2>
        <p>Di sini Anda dapat membuat cadangan (backup) seluruh data aplikasi atau mengembalikan (restore) data dari file cadangan.</p>
        <div class="wali-kelas-container">
            <h3>Backup Data</h3>
            <p>Menyimpan semua data (siswa, sekolah, nilai, dll.) ke dalam satu file <code>.json</code>. File ini dapat digunakan untuk cadangan atau dipindahkan ke perangkat lain.</p>
            <button class="btn" onclick="backupAllData()">Unduh Backup Semua Data (JSON)</button>
            <button class="btn" onclick="resetAllData()" style="background:#b30000;color:white;">RESET SEMUA DATA</button>
        </div>
        <div class="wali-kelas-container">
            <h3>Restore Data</h3>
            <p>Mengembalikan data dari file backup <code>.json</code> yang telah Anda unduh sebelumnya.</p>
            <p style="color: red;"><strong>Perhatian:</strong> Tindakan ini akan mengganti <strong>SEMUA DATA</strong> yang ada saat ini dengan data dari file backup.</p>
            <label>Unggah File Backup (.json)</label>
            <input type='file' id='uploadJSON' accept='.json' onchange='restoreAllData(event)'>
        </div>
    `;
}
function resetAllData(){
 if(confirm('Hapus semua data? Ini tidak dapat dibatalkan.')){ localStorage.clear(); alert('Semua data terhapus. Halaman akan dimuat ulang.'); location.reload(); }
}
function backupAllData() {
    const allData = {
        dataSekolah: JSON.parse(localStorage.getItem('dataSekolah')) || {},
        dataSiswa: JSON.parse(localStorage.getItem('dataSiswa')) || [],
        mapel: JSON.parse(localStorage.getItem('mapel')) || [],
        jurusan: JSON.parse(localStorage.getItem('jurusan')) || [],
        ekstrakurikuler: JSON.parse(localStorage.getItem('ekstrakurikuler')) || [],
        dataNilai: JSON.parse(localStorage.getItem('dataNilai')) || {},
        dataNilaiP5: JSON.parse(localStorage.getItem('dataNilaiP5')) || {},
        dataAbsen:JSON.parse(localStorage.getItem('dataAbsen')) || {},
        dataEkstra: JSON.parse(localStorage.getItem('dataEkstra')) || {},
        dataCatatanWaliKelas: JSON.parse(localStorage.getItem('dataCatatanWaliKelas')) || {},
        dataBuktiAmbilRapor: JSON.parse(localStorage.getItem('dataBuktiAmbilRapor')) || {},
        dataKD: JSON.parse(localStorage.getItem('dataKD')) || {},
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_data_aplikasi_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('Backup data berhasil diunduh!');
}

function restoreAllData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const isConfirmed = confirm('Apakah Anda yakin? SEMUA data yang ada saat ini akan ditimpa dengan data dari file backup ini.');
            if (!isConfirmed) {
                document.getElementById('uploadJSON').value = '';
                return;
            }

            if (data.dataSekolah) localStorage.setItem('dataSekolah', JSON.stringify(data.dataSekolah));
            if (data.dataSiswa) localStorage.setItem('dataSiswa', JSON.stringify(data.dataSiswa));
            if (data.mapel) localStorage.setItem('mapel', JSON.stringify(data.mapel));
            if (data.jurusan) localStorage.setItem('jurusan', JSON.stringify(data.jurusan));
            if (data.ekstrakurikuler) localStorage.setItem('ekstrakurikuler', JSON.stringify(data.ekstrakurikuler));
            if (data.dataNilai) localStorage.setItem('dataNilai', JSON.stringify(data.dataNilai));
            if (data.dataNilaiP5) localStorage.setItem('dataNilaiP5', JSON.stringify(data.dataNilaiP5));
            if (data.dataAbsen) localStorage.setItem('dataAbsen', JSON.stringify(data.dataAbsen));
            if (data.dataEkstra) localStorage.setItem('dataEkstra', JSON.stringify(data.dataEkstra));
            if (data.dataCatatanWaliKelas) localStorage.setItem('dataCatatanWaliKelas', JSON.stringify(data.dataCatatanWaliKelas));
            if (data.dataBuktiAmbilRapor) localStorage.setItem('dataBuktiAmbilRapor', JSON.stringify(data.dataBuktiAmbilRapor));
            if (data.dataKD) localStorage.setItem('dataKD', JSON.stringify(data.dataKD));
            
            alert('Data berhasil dikembalikan dari backup! Halaman akan dimuat ulang.');
            document.getElementById('uploadJSON').value = '';
            location.reload();
        } catch (error) {
            alert('Gagal memproses file. Pastikan file yang diunggah adalah file backup JSON yang valid.');
            console.error(error);
            document.getElementById('uploadJSON').value = '';
        }
    };
    reader.readAsText(file);
}

</script>

</body>
</html>